/*******************************************************************************
 * RBAC STORED PROCEDURE: Help System
 * 
 * Purpose: Provides interactive documentation for the RBAC framework
 *          Call RBAC_HELP() to get started
 * 
 * Usage:
 *   CALL RBAC_HELP();                    -- List all topics
 *   CALL RBAC_HELP('SETUP');             -- Initial setup guide
 *   CALL RBAC_HELP('ROLES');             -- Role naming conventions
 *   CALL RBAC_HELP('PROCEDURES');        -- Procedure reference
 ******************************************************************************/

-- =============================================================================
-- MAIN HELP PROCEDURE
-- =============================================================================

CREATE OR REPLACE SECURE PROCEDURE RBAC_HELP(
    P_TOPIC VARCHAR DEFAULT NULL
)
RETURNS TABLE (DOCUMENTATION VARCHAR)
LANGUAGE SQL
EXECUTE AS CALLER
AS
$$
DECLARE
    v_topic VARCHAR := UPPER(COALESCE(P_TOPIC, 'INDEX'));
    res RESULTSET;
BEGIN
    CASE v_topic
    
    -- =========================================================================
    -- INDEX - List of all topics
    -- =========================================================================
    WHEN 'INDEX' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     RBAC FRAMEWORK - HELP SYSTEM                             ║'),
('╠══════════════════════════════════════════════════════════════════════════════╣'),
('║  Call RBAC_HELP(''<topic>'') for detailed information on each topic           ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('AVAILABLE TOPICS:'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  GETTING STARTED'),
('  ────────────────'),
('    OVERVIEW        Overview of the RBAC framework'),
('    SETUP           Initial setup and configuration steps'),
('    QUICKSTART      Quick start guide for common tasks'),
(''),
('  ROLE STRUCTURE'),
('  ──────────────'),
('    ROLES           Role naming conventions and hierarchy'),
('    SRS             System roles (SRS_*) reference'),
('    SRF             Functional roles (SRF_*) reference'),
('    SRA             Access roles (SRA_*) reference'),
('    SRW             Wrapper/Service roles (SRW_*) reference'),
('    SRD             Database roles (SRD_*) reference'),
(''),
('  PROCEDURES'),
('  ──────────'),
('    PROCEDURES      All procedures quick reference'),
('    PROC_SETUP      Setup procedures'),
('    PROC_SCHEMA     Schema and database procedures'),
('    PROC_ACCESS     Access management procedures'),
('    PROC_USER       User management procedures'),
('    PROC_SERVICE    Service account procedures'),
('    PROC_AUDIT      Audit and monitoring procedures'),
(''),
('  ADVANCED'),
('  ────────'),
('    SSO             SSO and SCIM integration'),
('    SCIM_MODELS     SCIM provisioning models (A vs B)'),
('    MULTI_ACCOUNT   Multi-account architecture'),
('    EXTERNAL        External integrations (ServiceNow, Jira)'),
('    EXTENSIBILITY   Adding new Snowflake features'),
('    NATIVE_APP      Native App packaging'),
(''),
('  DEVOPS & CI/CD'),
('  ──────────────'),
('    DEVOPS          DevOps overview and architecture'),
('    DEVOPS_SETUP    Pipeline setup (Azure, GitHub, GitLab)'),
('    DEVOPS_GIT      Snowflake native Git integration'),
('    DEVOPS_DEPLOY   Deployment tracking and execution'),
('    DEVOPS_PROMOTE  Environment promotion workflows'),
('    DEVOPS_ROLLBACK Rollback procedures'),
(''),
('  CLONE MANAGEMENT'),
('  ────────────────'),
('    CLONES          Clone management overview'),
('    CLONE_CREATE    Creating clones with limits'),
('    CLONE_MANAGE    List, delete, replace clones'),
('    CLONE_AUDIT     Audit trail and compliance'),
('    CLONE_POLICIES  Compliance policy management'),
(''),
('  MONITORING DASHBOARDS'),
('  ─────────────────────'),
('    MONITORING      Overview of all dashboards'),
('    MON_SECURITY    Security monitoring dashboard'),
('    MON_CLONES      Clone monitoring dashboard'),
('    MON_DEVOPS      DevOps monitoring dashboard'),
(''),
('  DATA GOVERNANCE'),
('  ───────────────'),
('    GOVERNANCE      Data governance overview (RLS, Masking, Classification)'),
(''),
('  BACKUP MANAGEMENT'),
('  ─────────────────'),
('    BACKUP          Backup management overview'),
('    BACKUP_CREATE   Creating and restoring backups'),
('    BACKUP_POLICIES Backup policies and scheduling'),
('    MON_BACKUP      Backup monitoring dashboard'),
(''),
('  HA/DR'),
('  ─────'),
('    HADR            HA/DR overview'),
('    HADR_REPLICATION Setting up replication'),
('    HADR_FAILOVER   Failover and failback procedures'),
('    HADR_TESTING    DR testing and validation'),
('    MON_HADR        HA/DR monitoring dashboard'),
(''),
('  EXAMPLES'),
('  ────────'),
('    EXAMPLE_SETUP   Complete setup walkthrough'),
('    EXAMPLE_USER    User onboarding example'),
('    EXAMPLE_SERVICE Service account example'),
('    EXAMPLE_DEVOPS  CI/CD pipeline example'),
('    EXAMPLE_CLONE   Clone management example'),
(''),
('─────────────────────────────────────────────────────────────────────────────────'),
('Usage: CALL RBAC_HELP(''SETUP'');')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- OVERVIEW
    -- =========================================================================
    WHEN 'OVERVIEW' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     RBAC FRAMEWORK - OVERVIEW                                ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('WHAT IS THIS FRAMEWORK?'),
('─────────────────────────────────────────────────────────────────────────────────'),
('A comprehensive Role-Based Access Control system for Snowflake that provides:'),
(''),
('  • Environment separation (DEV, TST, UAT, PPE, PRD)'),
('  • Capability-based access (what you can do)'),
('  • Data segregation by domain (where you can do it)'),
('  • Service account management'),
('  • SSO/SCIM integration'),
('  • Audit and compliance tools'),
(''),
('KEY CONCEPTS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  FUNCTIONAL ROLES (SRF_*)     =  WHAT you can do (capabilities)'),
('                                  END_USER → ANALYST → DEVELOPER → DBADMIN'),
(''),
('  ACCESS ROLES (SRA_*)         =  WHERE you can do it (data access)'),
('                                  HR_ACCESS, SALES_ACCESS, FINANCE_ACCESS'),
(''),
('  USER ASSIGNMENT              =  SRF_* + SRA_* (capabilities + data)'),
('                                  Users get BOTH types of roles'),
(''),
('ARCHITECTURE DIAGRAM'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('                    ┌─────────────────────────────────────┐'),
('                    │           ACCOUNTADMIN              │'),
('                    └──────────────┬──────────────────────┘'),
('                                   │'),
('           ┌───────────────────────┼───────────────────────┐'),
('           ▼                       ▼                       ▼'),
('  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐'),
('  │ SRS_ACCOUNT_    │    │ SRS_SECURITY_   │    │ SRS_SYSTEM_     │'),
('  │ ADMIN           │    │ ADMIN           │    │ ADMIN           │'),
('  └─────────────────┘    └────────┬────────┘    └────────┬────────┘'),
('                                  │                      │'),
('                    ┌─────────────┴─────────────┐        │'),
('                    ▼                           ▼        ▼'),
('           ┌─────────────────┐         ┌─────────────────────────┐'),
('           │ SRF_*_DBADMIN   │         │ SRF_*_DEVELOPER/ANALYST │'),
('           │ (per env)       │         │ (per env)               │'),
('           └────────┬────────┘         └───────────┬─────────────┘'),
('                    │                              │'),
('           ┌────────┴────────┐            ┌───────┴───────┐'),
('           ▼                 ▼            ▼               ▼'),
('    ┌────────────┐    ┌────────────┐  ┌────────┐    ┌────────┐'),
('    │ SRA_*_     │    │ SRA_*_     │  │ SRA_*_ │    │ SRA_*_ │'),
('    │ HR_ACCESS  │    │SALES_ACCESS│  │  ...   │    │  ...   │'),
('    └─────┬──────┘    └─────┬──────┘  └────────┘    └────────┘'),
('          │                 │'),
('    ┌─────┴──────┐    ┌─────┴──────┐'),
('    │SRD_HR_*    │    │SRD_SALES_* │  (Database Roles)'),
('    │READ/WRITE  │    │READ/WRITE  │'),
('    └────────────┘    └────────────┘'),
(''),
('─────────────────────────────────────────────────────────────────────────────────'),
('Next: CALL RBAC_HELP(''SETUP'');')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- SETUP
    -- =========================================================================
    WHEN 'SETUP' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     RBAC FRAMEWORK - SETUP GUIDE                             ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('PREREQUISITES'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  • ACCOUNTADMIN role access'),
('  • Snowflake Enterprise Edition or higher (for some features)'),
(''),
('STEP 1: INITIAL CONFIGURATION'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  -- Run as ACCOUNTADMIN'),
('  USE ROLE ACCOUNTADMIN;'),
(''),
('  -- Preview what will be created (dry run)'),
('  CALL RBAC_INITIAL_CONFIG(NULL, TRUE);'),
(''),
('  -- Execute the setup'),
('  CALL RBAC_INITIAL_CONFIG(NULL, FALSE);'),
(''),
('  This creates:'),
('    • SRS_* system roles (ACCOUNT_ADMIN, SECURITY_ADMIN, etc.)'),
('    • SRF_* functional roles for all environments'),
('    • Role hierarchy and account settings'),
(''),
('STEP 2: CREATE WAREHOUSES'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  -- Create warehouse for each environment'),
('  USE ROLE SRF_DEV_DBADMIN;'),
('  CALL RBAC_CREATE_WAREHOUSE(''DEV'', ''XSMALL'', 60, NULL);'),
(''),
('  USE ROLE SRF_PRD_DBADMIN;'),
('  CALL RBAC_CREATE_WAREHOUSE(''PRD'', ''MEDIUM'', 120, NULL);'),
(''),
('STEP 3: CREATE DATABASE AND SCHEMA'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  -- Create database and schema'),
('  USE ROLE SRF_DEV_DBADMIN;'),
('  CALL RBAC_CREATE_SCHEMA(''DEV'', ''HR'', ''EMPLOYEES'', ''Employee data'');'),
(''),
('STEP 4: CREATE ACCESS ROLE'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  -- Create access role for HR team'),
('  USE ROLE SRS_SECURITY_ADMIN;'),
('  CALL RBAC_CREATE_ACCESS_ROLE(''DEV'', ''HR'', ''HR team data access'');'),
(''),
('STEP 5: LINK SCHEMA TO ACCESS ROLE'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  -- Grant HR access role access to EMPLOYEES schema'),
('  CALL RBAC_LINK_SCHEMA_TO_ACCESS_ROLE(''DEV'', ''HR'', ''HR'', ''EMPLOYEES'', ''WRITE'');'),
(''),
('STEP 6: CONFIGURE USERS'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  -- Configure a user with HR Developer access'),
('  CALL RBAC_CONFIGURE_USER('),
('      ''john.doe@company.com'',  -- username'),
('      ''DEV'',                   -- environment'),
('      ''HR'',                    -- domain'),
('      ''DEVELOPER'',             -- capability'),
('      ''DEV_WH'',                -- warehouse'),
('      NULL                      -- additional domains'),
('  );'),
(''),
('─────────────────────────────────────────────────────────────────────────────────'),
('Next: CALL RBAC_HELP(''ROLES''); or CALL RBAC_HELP(''EXAMPLE_SETUP'');')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- QUICKSTART
    -- =========================================================================
    WHEN 'QUICKSTART' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     RBAC FRAMEWORK - QUICKSTART                              ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('COMMON TASKS - COPY & PASTE READY'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('1. SETUP NEW ENVIRONMENT'),
('   USE ROLE ACCOUNTADMIN;'),
('   CALL RBAC_INITIAL_CONFIG(ARRAY_CONSTRUCT(''DEV'', ''PRD''), FALSE);'),
(''),
('2. CREATE NEW SCHEMA'),
('   USE ROLE SRF_DEV_DBADMIN;'),
('   CALL RBAC_CREATE_SCHEMA(''DEV'', ''SALES'', ''ORDERS'', ''Sales orders'');'),
(''),
('3. CREATE ACCESS ROLE & LINK SCHEMA'),
('   USE ROLE SRS_SECURITY_ADMIN;'),
('   CALL RBAC_CREATE_ACCESS_ROLE(''DEV'', ''SALES'', ''Sales team access'');'),
('   CALL RBAC_LINK_SCHEMA_TO_ACCESS_ROLE(''DEV'', ''SALES'', ''SALES'', ''ORDERS'', ''WRITE'');'),
(''),
('4. ONBOARD A USER'),
('   USE ROLE SRS_SECURITY_ADMIN;'),
('   CALL RBAC_CONFIGURE_USER(''user@company.com'', ''DEV'', ''SALES'', ''ANALYST'', ''DEV_WH'', NULL);'),
(''),
('5. CREATE SERVICE ACCOUNT'),
('   USE ROLE SRS_SECURITY_ADMIN;'),
('   CALL RBAC_CREATE_SERVICE_ACCOUNT(''ETL_SERVICE'', ''<RSA_KEY>'', ''DEV'', ''SALES'', ''DEVELOPER'', ''DEV_WH'', ''ETL service'', NULL);'),
(''),
('6. AUDIT USER ACCESS'),
('   CALL RBAC_AUDIT_USER_ROLES(''DEV'', TRUE);'),
('   CALL RBAC_GET_USER_ROLE_SUMMARY(''user@company.com'');'),
(''),
('7. CHECK SCHEMA CONFIGURATION'),
('   CALL RBAC_MONITOR_CONFIG(''DEV'', ''SALES'', ''ORDERS'');'),
(''),
('8. FIX CONFIGURATION ISSUES'),
('   CALL RBAC_RECTIFY_CONFIG(''DEV'', ''SALES'', ''ORDERS'', TRUE);  -- dry run'),
('   CALL RBAC_RECTIFY_CONFIG(''DEV'', ''SALES'', ''ORDERS'', FALSE); -- execute'),
(''),
('─────────────────────────────────────────────────────────────────────────────────'),
('For detailed help: CALL RBAC_HELP(''PROCEDURES'');')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- ROLES
    -- =========================================================================
    WHEN 'ROLES' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     RBAC FRAMEWORK - ROLE NAMING                             ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('ROLE PREFIXES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  | Prefix | Type            | Purpose                                        |'),
('  |--------|-----------------|------------------------------------------------|'),
('  | SRS_   | System Role     | Account-level administration                   |'),
('  | SRF_   | Functional Role | Capability (what you can do)                   |'),
('  | SRA_   | Access Role     | Data access (where you can do it)              |'),
('  | SRW_   | Wrapper Role    | Service accounts (combined cap + access)       |'),
('  | SRD_   | Database Role   | Schema-level access (granted to SRA_*)         |'),
(''),
('NAMING PATTERNS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  SRS_<FUNCTION>                    Example: SRS_SECURITY_ADMIN'),
('  SRF_<ENV>_<CAPABILITY>            Example: SRF_DEV_DEVELOPER'),
('  SRA_<ENV>_<DOMAIN>_ACCESS         Example: SRA_DEV_HR_ACCESS'),
('  SRW_<ENV>_<DOMAIN>_<CAPABILITY>   Example: SRW_PRD_SALES_ANALYST'),
('  SRD_<DOMAIN>_<ENV>_<SCHEMA>_<RW>  Example: SRD_HR_DEV_EMPLOYEES_READ'),
(''),
('FUNCTIONAL ROLE HIERARCHY'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  SRF_*_END_USER        Basic read access'),
('       │'),
('       ▼'),
('  SRF_*_ANALYST         Query and analyze'),
('       │'),
('       ▼'),
('  SRF_*_DEVELOPER       Create objects (DEV only: write)'),
('       │'),
('       ▼'),
('  SRF_*_TEAM_LEADER     Manage team access'),
('       │'),
('       ▼'),
('  SRF_*_DATA_SCIENTIST  ML and advanced analytics'),
('       │'),
('       ▼'),
('  SRF_*_DBADMIN         Full admin for environment'),
(''),
('─────────────────────────────────────────────────────────────────────────────────'),
('Details: CALL RBAC_HELP(''SRS''); CALL RBAC_HELP(''SRF''); CALL RBAC_HELP(''SRA'');')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- SRS - System Roles
    -- =========================================================================
    WHEN 'SRS' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     SYSTEM ROLES (SRS_*)                                     ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('PURPOSE: Account-level administration roles'),
(''),
('ROLES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  SRS_ACCOUNT_ADMIN'),
('    • Top-level custom admin role'),
('    • Granted to ACCOUNTADMIN'),
('    • Owns other SRS_* roles'),
(''),
('  SRS_SECURITY_ADMIN'),
('    • Manages roles, grants, and access'),
('    • Creates/manages SRA_* access roles'),
('    • Configures user access'),
('    • Privileges: CREATE ROLE, MANAGE GRANTS'),
(''),
('  SRS_USER_ADMIN'),
('    • User account management'),
('    • Creates users (if not using SCIM)'),
('    • Privileges: CREATE USER'),
(''),
('  SRS_SYSTEM_ADMIN'),
('    • Infrastructure management'),
('    • Owns SRF_*_DBADMIN roles'),
('    • Granted to SYSADMIN'),
(''),
('  SRS_DATA_SHARING_ADMIN'),
('    • Cross-account data sharing'),
('    • Manages shares and listings'),
('    • Privileges: CREATE SHARE, IMPORT SHARE'),
(''),
('HIERARCHY'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  ACCOUNTADMIN'),
('       │'),
('       └──► SRS_ACCOUNT_ADMIN'),
('                 │'),
('                 ├──► SRS_SECURITY_ADMIN ──► SRS_USER_ADMIN'),
('                 │'),
('                 ├──► SRS_SYSTEM_ADMIN'),
('                 │'),
('                 └──► SRS_DATA_SHARING_ADMIN'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- SRF - Functional Roles
    -- =========================================================================
    WHEN 'SRF' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     FUNCTIONAL ROLES (SRF_*)                                 ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('PURPOSE: Define WHAT users can do (capabilities)'),
(''),
('NAMING: SRF_<ENVIRONMENT>_<CAPABILITY>'),
(''),
('CAPABILITY LEVELS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  | Level          | Capabilities                                     |'),
('  |----------------|--------------------------------------------------|'),
('  | END_USER       | Basic SELECT, use warehouses                     |'),
('  | ANALYST        | + Complex queries, create views                  |'),
('  | DEVELOPER      | + Create objects, write (DEV only)               |'),
('  | TEAM_LEADER    | + Monitor usage, manage team                     |'),
('  | DATA_SCIENTIST | + ML functions, notebooks                        |'),
('  | DBADMIN        | + Full admin, create databases/warehouses        |'),
(''),
('ENVIRONMENT-SPECIFIC BEHAVIOR'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  DEV Environment:'),
('    • DEVELOPER and above can WRITE (INSERT/UPDATE/DELETE)'),
('    • Full development capabilities'),
(''),
('  TST/UAT/PPE/PRD Environments:'),
('    • All roles are READ-ONLY'),
('    • No direct writes allowed'),
('    • Changes via deployment pipelines'),
(''),
('EXAMPLES'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  SRF_DEV_DEVELOPER    - Can develop in DEV'),
('  SRF_PRD_ANALYST      - Can query PRD data'),
('  SRF_UAT_DBADMIN      - Admin for UAT environment'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- SRA - Access Roles
    -- =========================================================================
    WHEN 'SRA' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     ACCESS ROLES (SRA_*)                                     ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('PURPOSE: Define WHERE users can access data (domains)'),
(''),
('NAMING: SRA_<ENVIRONMENT>_<DOMAIN>_ACCESS'),
(''),
('STRUCTURE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  SRA_* Access Role'),
('       │'),
('       └──► Contains SRD_* Database Roles'),
('                 │'),
('                 └──► Schema-level READ or WRITE access'),
(''),
('HOW IT WORKS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  1. Create access role:'),
('     CALL RBAC_CREATE_ACCESS_ROLE(''DEV'', ''HR'', ''HR team access'');'),
('     Creates: SRA_DEV_HR_ACCESS'),
(''),
('  2. Link schemas to access role:'),
('     CALL RBAC_LINK_SCHEMA_TO_ACCESS_ROLE(''DEV'', ''HR'', ''HR'', ''EMPLOYEES'', ''WRITE'');'),
('     Grants: SRD_HR_DEV_EMPLOYEES_WRITE to SRA_DEV_HR_ACCESS'),
(''),
('  3. Grant to users:'),
('     User gets SRA_DEV_HR_ACCESS → can access HR schemas'),
(''),
('CROSS-DOMAIN ACCESS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  Users can have multiple SRA_* roles via SECONDARY_ROLES:'),
(''),
('  User: john.doe@company.com'),
('    ├── SRA_DEV_HR_ACCESS       (primary domain)'),
('    ├── SRA_DEV_FINANCE_ACCESS  (additional domain)'),
('    └── SRA_DEV_SALES_ACCESS    (additional domain)'),
(''),
('  Configure with:'),
('  CALL RBAC_CONFIGURE_USER(''john.doe@company.com'', ''DEV'', ''HR'', ''ANALYST'','),
('      ''DEV_WH'', ARRAY_CONSTRUCT(''FINANCE'', ''SALES''));'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- SRW - Wrapper/Service Roles
    -- =========================================================================
    WHEN 'SRW' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     WRAPPER ROLES (SRW_*)                                    ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('PURPOSE: Combined capability + access for service accounts'),
(''),
('NAMING: SRW_<ENVIRONMENT>_<DOMAIN>_<CAPABILITY>'),
(''),
('WHY WRAPPER ROLES?'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  Service accounts need:'),
('    • Specific capability (SRF_*)'),
('    • Specific data access (SRA_*)'),
('    • Single role for simplicity'),
(''),
('  SRW_* combines both into one assignable role'),
(''),
('STRUCTURE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  SRW_PRD_HR_ANALYST'),
('       │'),
('       ├──► SRF_PRD_ANALYST     (capability)'),
('       │'),
('       └──► SRA_PRD_HR_ACCESS   (data access)'),
(''),
('USAGE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create wrapper role'),
('  CALL RBAC_CREATE_SERVICE_ROLE(''PRD'', ''HR'', ''ANALYST'', ''HR reporting service'');'),
(''),
('  -- Create service account with wrapper role'),
('  CALL RBAC_CREATE_SERVICE_ACCOUNT('),
('      ''HR_REPORTING_SVC'','),
('      ''<RSA_PUBLIC_KEY>'','),
('      ''PRD'','),
('      ''HR'','),
('      ''ANALYST'','),
('      ''PRD_WH'','),
('      ''HR reporting service account'','),
('      NULL'),
('  );'),
(''),
('  The service account gets SRW_PRD_HR_ANALYST as default role'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- SRD - Database Roles
    -- =========================================================================
    WHEN 'SRD' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     DATABASE ROLES (SRD_*)                                   ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('PURPOSE: Schema-level access control (Snowflake database roles)'),
(''),
('NAMING: SRD_<DOMAIN>_<ENVIRONMENT>_<SCHEMA>_<READ|WRITE>'),
(''),
('WHAT ARE DATABASE ROLES?'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  • Snowflake feature for schema-level access'),
('  • Created within a database'),
('  • Can only access objects in that database'),
('  • More granular than account-level roles'),
(''),
('TWO TYPES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  SRD_*_READ'),
('    • SELECT on all tables/views'),
('    • USAGE on schema and database'),
('    • Created for all environments'),
(''),
('  SRD_*_WRITE'),
('    • All READ privileges plus'),
('    • INSERT, UPDATE, DELETE, TRUNCATE'),
('    • CREATE TABLE, CREATE VIEW, etc.'),
('    • Only meaningful in DEV environment'),
(''),
('AUTOMATIC CREATION'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  When you run:'),
('  CALL RBAC_CREATE_SCHEMA(''DEV'', ''HR'', ''EMPLOYEES'', ''Employee data'');'),
(''),
('  These are created automatically:'),
('    • SRD_HR_DEV_EMPLOYEES_READ'),
('    • SRD_HR_DEV_EMPLOYEES_WRITE'),
(''),
('  Then link to access role:'),
('  CALL RBAC_LINK_SCHEMA_TO_ACCESS_ROLE(''DEV'', ''HR'', ''HR'', ''EMPLOYEES'', ''WRITE'');'),
(''),
('  This grants SRD_HR_DEV_EMPLOYEES_WRITE to SRA_DEV_HR_ACCESS'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- PROCEDURES - Quick Reference
    -- =========================================================================
    WHEN 'PROCEDURES' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     PROCEDURE QUICK REFERENCE                                ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('INITIAL SETUP'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  RBAC_INITIAL_CONFIG(environments, dry_run)'),
(''),
('INFRASTRUCTURE'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  RBAC_CREATE_WAREHOUSE(env, size, auto_suspend, suffix)'),
('  RBAC_CREATE_SCHEMA(env, database, schema, comment)'),
(''),
('ACCESS MANAGEMENT'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  RBAC_CREATE_ACCESS_ROLE(env, domain, comment)'),
('  RBAC_LINK_SCHEMA_TO_ACCESS_ROLE(env, domain, database, schema, access_level)'),
('  RBAC_GRANT_USER_ACCESS(user, env, domain, capability)'),
('  RBAC_REVOKE_USER_ACCESS(user, env, domain, revoke_functional)'),
(''),
('USER MANAGEMENT'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  RBAC_CONFIGURE_USER(user, env, domain, capability, warehouse, additional_domains)'),
('  RBAC_DISABLE_USER(user, reason)'),
(''),
('SERVICE ACCOUNTS'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  RBAC_CREATE_SERVICE_ROLE(env, domain, capability, comment)'),
('  RBAC_CREATE_SERVICE_ACCOUNT(name, rsa_key, env, domain, capability, warehouse, comment, rsa_key_2)'),
('  RBAC_GRANT_SERVICE_ACCOUNT(service, env, domain, capability, set_default)'),
('  RBAC_REVOKE_SERVICE_ACCOUNT(service, env, domain, capability)'),
('  RBAC_ROTATE_SERVICE_KEY(account, new_key, key_slot)'),
(''),
('AUDIT & MONITORING'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  RBAC_AUDIT_USER_ROLES(env, include_details)'),
('  RBAC_GENERATE_REMEDIATION_SCRIPT(env)'),
('  RBAC_GET_USER_ROLE_SUMMARY(user)'),
('  RBAC_MONITOR_CONFIG(env, database, schema)'),
('  RBAC_RECTIFY_CONFIG(env, database, schema, dry_run)'),
(''),
('SSO/SCIM'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  RBAC_SETUP_SSO_OKTA(name, issuer, sso_url, cert)'),
('  RBAC_SETUP_SSO_AZURE_AD(name, issuer, sso_url, cert)'),
('  RBAC_SETUP_MODEL_A_BASIC_SCIM(idp_type, name, network_policy)'),
('  RBAC_SETUP_MODEL_B_FULL_SCIM(idp_type, name, network_policy)'),
('  RBAC_GENERATE_SCIM_TOKEN(integration_name)'),
(''),
('─────────────────────────────────────────────────────────────────────────────────'),
('Details: CALL RBAC_HELP(''PROC_SETUP''); CALL RBAC_HELP(''PROC_USER''); etc.')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- SSO
    -- =========================================================================
    WHEN 'SSO' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     SSO & SCIM INTEGRATION                                   ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('OVERVIEW'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  SSO  = Single Sign-On (SAML 2.0) - How users authenticate'),
('  SCIM = User provisioning - How users are created/managed'),
(''),
('SSO SETUP'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Okta'),
('  CALL RBAC_SETUP_SSO_OKTA('),
('      ''OKTA_SSO'',                                    -- integration name'),
('      ''http://www.okta.com/exk123abc'',              -- issuer URL'),
('      ''https://company.okta.com/app/.../sso/saml'',  -- SSO URL'),
('      ''MIICnTCCAYUCBgF...''                          -- certificate'),
('  );'),
(''),
('  -- Azure AD'),
('  CALL RBAC_SETUP_SSO_AZURE_AD('),
('      ''AZURE_SSO'','),
('      ''https://sts.windows.net/{tenant-id}/'','),
('      ''https://login.microsoftonline.com/{tenant}/saml2'','),
('      ''MIICnTCCAYUCBgF...'''),
('  );'),
(''),
('SCIM PROVISIONING'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  Two models available - see: CALL RBAC_HELP(''SCIM_MODELS'');'),
(''),
('  Model A: SCIM creates users → Admin assigns roles manually'),
('  Model B: SCIM creates users AND assigns roles via AD groups'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- SCIM_MODELS
    -- =========================================================================
    WHEN 'SCIM_MODELS' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     SCIM PROVISIONING MODELS                                 ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('MODEL A: SCIM + MANUAL RBAC'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  How it works:'),
('    1. SCIM auto-creates user accounts from IdP'),
('    2. Admin manually assigns roles via RBAC_CONFIGURE_USER'),
(''),
('  Setup:'),
('    CALL RBAC_SETUP_MODEL_A_BASIC_SCIM(''OKTA'', ''OKTA_SCIM'', NULL);'),
('    CALL RBAC_GENERATE_SCIM_TOKEN(''OKTA_SCIM'');'),
(''),
('  After user syncs:'),
('    CALL RBAC_CONFIGURE_USER(''new.user@company.com'', ''DEV'', ''HR'', ''DEVELOPER'', ''DEV_WH'', NULL);'),
(''),
('  Best for: Smaller orgs, infrequent role changes'),
(''),
('MODEL B: FULL SCIM AUTOMATION'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  How it works:'),
('    1. SCIM auto-creates user accounts'),
('    2. SCIM auto-assigns roles via AD group membership'),
('    3. Roles change automatically when AD groups change'),
(''),
('  Setup:'),
('    CALL RBAC_SETUP_MODEL_B_FULL_SCIM(''OKTA'', ''OKTA_SCIM'', NULL);'),
('    CALL RBAC_GRANT_ALL_ROLES_TO_SCIM(''OKTA'', NULL);'),
('    CALL RBAC_GENERATE_SCIM_TOKEN(''OKTA_SCIM'');'),
(''),
('  AD Group naming convention:'),
('    SF_DEV_DEVELOPER     → SRF_DEV_DEVELOPER'),
('    SF_DEV_HR_ACCESS     → SRA_DEV_HR_ACCESS'),
('    SF_PRD_ANALYST       → SRF_PRD_ANALYST'),
(''),
('  Best for: Larger orgs, frequent role changes, centralized management'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- MULTI_ACCOUNT
    -- =========================================================================
    WHEN 'MULTI_ACCOUNT' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     MULTI-ACCOUNT ARCHITECTURE                               ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('THREE SCENARIOS SUPPORTED'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  SCENARIO 1: ENVIRONMENT-BASED ACCOUNTS'),
('    Accounts: DEV, TST, UAT, PRD (each has all domains)'),
('    Roles: SRF_DEVELOPER, SRA_HR_ACCESS (no env prefix)'),
('    Setup: CALL RBAC_INITIAL_CONFIG_MULTI_ACCOUNT(''ENVIRONMENT'', ''DEV'', ...);'),
(''),
('  SCENARIO 2: DEPARTMENT-BASED ACCOUNTS'),
('    Accounts: HR, SALES, FINANCE (each has all environments)'),
('    Roles: SRF_DEV_DEVELOPER, SRA_DEV_PAYROLL (no domain prefix)'),
('    Setup: CALL RBAC_INITIAL_CONFIG_MULTI_ACCOUNT(''DEPARTMENT'', ''HR'', ...);'),
(''),
('  SCENARIO 3: HYBRID'),
('    Accounts: HR-DEV, HR-PRD, SALES-DEV, SALES-PRD'),
('    Roles: SRF_DEVELOPER, SRA_PAYROLL (no prefixes)'),
('    Setup: CALL RBAC_INITIAL_CONFIG_MULTI_ACCOUNT(''HYBRID'', ''HR_DEV'', ...);'),
(''),
('CROSS-ACCOUNT DATA SHARING'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- In SOURCE account'),
('  CALL RBAC_CREATE_OUTBOUND_SHARE(''HR_SHARE'', ''HR_DB'','),
('      ARRAY_CONSTRUCT(''EMPLOYEES''), ARRAY_CONSTRUCT(''ORG.FINANCE_ACCT''), NULL);'),
(''),
('  -- In CONSUMER account'),
('  CALL RBAC_CREATE_SHARED_DATA_ACCESS_ROLE(''HR'', ''HR_DATA'', ''PRD'', NULL);'),
('  CALL RBAC_MOUNT_INBOUND_SHARE(''ORG.HR_ACCT.HR_SHARE'', ''HR_SHARED'','),
('      ''SRA_PRD_SHARED_HR_DATA_ACCESS'', NULL);'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- EXTERNAL
    -- =========================================================================
    WHEN 'EXTERNAL' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     EXTERNAL INTEGRATIONS                                    ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('SUPPORTED SYSTEMS'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  • ServiceNow (ITSM, SecOps)'),
('  • Jira (Service Management)'),
('  • Any REST API (extensible)'),
(''),
('WORKFLOW'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  1. User requests access → Ticket created'),
('  2. Manager approves in external system'),
('  3. Admin checks approval → Auto-grants access'),
(''),
('SETUP (ServiceNow example)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Step 1: Configure access (ACCOUNTADMIN)'),
('  CALL RBAC_SETUP_SERVICENOW_ACCESS('),
('      ''mycompany'',           -- instance'),
('      ''SNOW_CREDS'',          -- secret name'),
('      ''api_user'',            -- username'),
('      ''api_password'',        -- password'),
('      ''SNOW_INT''             -- integration name'),
('  );'),
(''),
('  -- Step 2: Grant to security admin'),
('  GRANT USAGE ON INTEGRATION SNOW_INT TO ROLE SRS_SECURITY_ADMIN;'),
(''),
('  -- Step 3: Create access request'),
('  CALL RBAC_REQUEST_ACCESS(''user@company.com'', ''DEV'', ''HR'', ''DEVELOPER'','),
('      ''Business justification...'', ''SERVICENOW'', NULL);'),
(''),
('  -- Step 4: Check approval and grant (after manager approves)'),
('  CALL RBAC_CHECK_AND_GRANT_APPROVED(''REQ0012345'', ''SERVICENOW'','),
('      ''user@company.com'', ''DEV'', ''HR'', ''DEVELOPER'', ''DEV_WH'');'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- EXTENSIBILITY
    -- =========================================================================
    WHEN 'EXTENSIBILITY' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     EXTENSIBILITY GUIDE                                      ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('WHERE TO UPDATE FOR NEW SNOWFLAKE FEATURES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  | Feature Type            | Primary File(s) to Update                      |'),
('  |-------------------------|------------------------------------------------|'),
('  | New object type         | RBAC_SP_Create_Schema.sql                      |'),
('  |                         | RBAC_SP_Monitor_Config.sql                     |'),
('  |                         | RBAC_SP_Rectify_Config.sql                     |'),
('  | New account privilege   | RBAC_SP_Initial_Config.sql                     |'),
('  |                         | RBAC_SP_Multi_Account.sql                      |'),
('  | New schema privilege    | RBAC_SP_Create_Schema.sql                      |'),
('  | New policy type         | RBAC_SP_Initial_Config.sql (APPLY privilege)   |'),
('  | New authentication      | RBAC_SP_Identity_Integration.sql               |'),
('  | New integration type    | RBAC_SP_Identity_Integration.sql               |'),
(''),
('EXAMPLE: ADDING NOTEBOOK SUPPORT'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  1. RBAC_SP_Initial_Config.sql:'),
('     Add: GRANT CREATE NOTEBOOK ON ACCOUNT TO ROLE <DBADMIN>'),
(''),
('  2. RBAC_SP_Create_Schema.sql:'),
('     Add: GRANT READ ON ALL NOTEBOOKS IN SCHEMA ... TO DATABASE ROLE ...'),
('     Add: GRANT READ ON FUTURE NOTEBOOKS IN SCHEMA ... TO DATABASE ROLE ...'),
(''),
('  3. RBAC_SP_Monitor_Config.sql:'),
('     Add: Check for notebook grants'),
(''),
('UPDATE PROCESS'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  1. Monitor Snowflake Release Notes'),
('  2. Identify privilege requirements'),
('  3. Update procedures'),
('  4. Test with dry_run=TRUE'),
('  5. Deploy and verify'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- NATIVE_APP
    -- =========================================================================
    WHEN 'NATIVE_APP' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     NATIVE APP PACKAGING                                     ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('PURPOSE'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  Package RBAC framework for secure distribution with full IP protection'),
(''),
('BENEFITS'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  ✓ Code completely hidden from consumers'),
('  ✓ Distributed via Private Marketplace Listings'),
('  ✓ Version control and updates'),
('  ✓ Maximum IP protection'),
(''),
('CURRENT PROTECTION: SECURE PROCEDURES'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  All procedures use CREATE OR REPLACE SECURE PROCEDURE'),
('  • Users with USAGE can execute'),
('  • GET_DDL() returns "Definition hidden"'),
('  • Only owner/ACCOUNTADMIN can see code'),
(''),
('NATIVE APP SETUP'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  See: RBAC_Native_App_Manifest.sql for complete instructions'),
(''),
('  Quick overview:'),
('    1. Create APPLICATION PACKAGE in provider account'),
('    2. Upload manifest.yml and setup_script.sql'),
('    3. Create Private Listing in Marketplace'),
('    4. Consumer installs from listing'),
('    5. Consumer cannot see any procedure code'),
(''),
('PROVIDER COMMANDS'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  CREATE APPLICATION PACKAGE RBAC_FRAMEWORK_PACKAGE;'),
('  ALTER APPLICATION PACKAGE ... ADD VERSION v1_0 USING ''@stage'';'),
('  ALTER APPLICATION PACKAGE ... SET DEFAULT RELEASE DIRECTIVE VERSION = v1_0;'),
(''),
('CONSUMER COMMANDS'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  CREATE APPLICATION RBAC_FRAMEWORK FROM LISTING ''RBAC Framework'';'),
('  CALL RBAC_FRAMEWORK.RBAC.RBAC_INITIAL_CONFIG(NULL, FALSE);'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- EXAMPLE_SETUP
    -- =========================================================================
    WHEN 'EXAMPLE_SETUP' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     EXAMPLE: COMPLETE SETUP WALKTHROUGH                      ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('SCENARIO: Setup RBAC for HR department with DEV and PRD environments'),
(''),
('STEP 1: INITIAL CONFIGURATION'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  USE ROLE ACCOUNTADMIN;'),
(''),
('  -- Initialize RBAC (creates system and functional roles)'),
('  CALL RBAC_INITIAL_CONFIG(ARRAY_CONSTRUCT(''DEV'', ''PRD''), FALSE);'),
(''),
('STEP 2: CREATE WAREHOUSES'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  USE ROLE SRF_DEV_DBADMIN;'),
('  CALL RBAC_CREATE_WAREHOUSE(''DEV'', ''XSMALL'', 60, NULL);'),
(''),
('  USE ROLE SRF_PRD_DBADMIN;'),
('  CALL RBAC_CREATE_WAREHOUSE(''PRD'', ''SMALL'', 120, NULL);'),
(''),
('STEP 3: CREATE DATABASE AND SCHEMAS'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  USE ROLE SRF_DEV_DBADMIN;'),
('  CALL RBAC_CREATE_SCHEMA(''DEV'', ''HR'', ''EMPLOYEES'', ''Employee master data'');'),
('  CALL RBAC_CREATE_SCHEMA(''DEV'', ''HR'', ''PAYROLL'', ''Payroll data'');'),
(''),
('  USE ROLE SRF_PRD_DBADMIN;'),
('  CALL RBAC_CREATE_SCHEMA(''PRD'', ''HR'', ''EMPLOYEES'', ''Employee master data'');'),
('  CALL RBAC_CREATE_SCHEMA(''PRD'', ''HR'', ''PAYROLL'', ''Payroll data'');'),
(''),
('STEP 4: CREATE ACCESS ROLES'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  USE ROLE SRS_SECURITY_ADMIN;'),
(''),
('  -- DEV access role'),
('  CALL RBAC_CREATE_ACCESS_ROLE(''DEV'', ''HR'', ''HR team DEV access'');'),
(''),
('  -- PRD access role'),
('  CALL RBAC_CREATE_ACCESS_ROLE(''PRD'', ''HR'', ''HR team PRD access'');'),
(''),
('STEP 5: LINK SCHEMAS TO ACCESS ROLES'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  -- DEV: WRITE access (developers can modify)'),
('  CALL RBAC_LINK_SCHEMA_TO_ACCESS_ROLE(''DEV'', ''HR'', ''HR'', ''EMPLOYEES'', ''WRITE'');'),
('  CALL RBAC_LINK_SCHEMA_TO_ACCESS_ROLE(''DEV'', ''HR'', ''HR'', ''PAYROLL'', ''WRITE'');'),
(''),
('  -- PRD: READ access only'),
('  CALL RBAC_LINK_SCHEMA_TO_ACCESS_ROLE(''PRD'', ''HR'', ''HR'', ''EMPLOYEES'', ''READ'');'),
('  CALL RBAC_LINK_SCHEMA_TO_ACCESS_ROLE(''PRD'', ''HR'', ''HR'', ''PAYROLL'', ''READ'');'),
(''),
('STEP 6: CONFIGURE USERS'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  -- HR Developer (DEV write + PRD read)'),
('  CALL RBAC_CONFIGURE_USER(''hr.dev@company.com'', ''DEV'', ''HR'', ''DEVELOPER'', ''DEV_WH'', NULL);'),
('  CALL RBAC_GRANT_USER_ACCESS(''hr.dev@company.com'', ''PRD'', ''HR'', ''ANALYST'');'),
(''),
('  -- HR Analyst (PRD read only)'),
('  CALL RBAC_CONFIGURE_USER(''hr.analyst@company.com'', ''PRD'', ''HR'', ''ANALYST'', ''PRD_WH'', NULL);'),
(''),
('VERIFICATION'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  CALL RBAC_GET_USER_ROLE_SUMMARY(''hr.dev@company.com'');'),
('  CALL RBAC_MONITOR_CONFIG(''DEV'', ''HR'', ''EMPLOYEES'');'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- EXAMPLE_USER
    -- =========================================================================
    WHEN 'EXAMPLE_USER' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     EXAMPLE: USER ONBOARDING                                 ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('SCENARIO: Onboard new analyst who needs HR and Finance data access'),
(''),
('OPTION 1: MANUAL CONFIGURATION'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  USE ROLE SRS_SECURITY_ADMIN;'),
(''),
('  -- Configure with primary domain (HR) and additional domain (Finance)'),
('  CALL RBAC_CONFIGURE_USER('),
('      ''new.analyst@company.com'',       -- username'),
('      ''DEV'',                           -- primary environment'),
('      ''HR'',                            -- primary domain'),
('      ''ANALYST'',                       -- capability level'),
('      ''DEV_WH'',                        -- default warehouse'),
('      ARRAY_CONSTRUCT(''FINANCE'')       -- additional domains'),
('  );'),
(''),
('  -- Result: User gets'),
('  --   SRF_DEV_ANALYST'),
('  --   SRA_DEV_HR_ACCESS'),
('  --   SRA_DEV_FINANCE_ACCESS'),
(''),
('OPTION 2: WITH EXTERNAL APPROVAL (ServiceNow)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Step 1: Create request ticket'),
('  CALL RBAC_REQUEST_ACCESS('),
('      ''new.analyst@company.com'','),
('      ''DEV'','),
('      ''HR'','),
('      ''ANALYST'','),
('      ''Need access to HR data for quarterly reporting project'','),
('      ''SERVICENOW'','),
('      NULL'),
('  );'),
('  -- Returns: REQ0012345'),
(''),
('  -- Step 2: Manager approves in ServiceNow'),
(''),
('  -- Step 3: Check approval and grant'),
('  CALL RBAC_CHECK_AND_GRANT_APPROVED('),
('      ''REQ0012345'','),
('      ''SERVICENOW'','),
('      ''new.analyst@company.com'','),
('      ''DEV'','),
('      ''HR'','),
('      ''ANALYST'','),
('      ''DEV_WH'''),
('  );'),
(''),
('ADDING MORE ACCESS LATER'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Add PRD read access'),
('  CALL RBAC_GRANT_USER_ACCESS(''new.analyst@company.com'', ''PRD'', ''HR'', ''ANALYST'');'),
(''),
('  -- Add another domain'),
('  CALL RBAC_GRANT_USER_ACCESS(''new.analyst@company.com'', ''DEV'', ''SALES'', NULL);'),
(''),
('VERIFICATION'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  CALL RBAC_GET_USER_ROLE_SUMMARY(''new.analyst@company.com'');'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- EXAMPLE_SERVICE
    -- =========================================================================
    WHEN 'EXAMPLE_SERVICE' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     EXAMPLE: SERVICE ACCOUNT                                 ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('SCENARIO: Create service account for ETL pipeline loading HR data'),
(''),
('STEP 1: CREATE SERVICE ROLE (wrapper role)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  USE ROLE SRS_SECURITY_ADMIN;'),
(''),
('  -- This creates SRW_DEV_HR_DEVELOPER'),
('  CALL RBAC_CREATE_SERVICE_ROLE('),
('      ''DEV'',                           -- environment'),
('      ''HR'',                            -- domain'),
('      ''DEVELOPER'',                     -- capability (needs write access)'),
('      ''ETL service for HR data loads''  -- comment'),
('  );'),
(''),
('STEP 2: CREATE SERVICE ACCOUNT'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Generate RSA key pair first (outside Snowflake)'),
('  -- openssl genrsa 2048 | openssl pkcs8 -topk8 -inform PEM -out rsa_key.p8 -nocrypt'),
('  -- openssl rsa -in rsa_key.p8 -pubout -out rsa_key.pub'),
(''),
('  CALL RBAC_CREATE_SERVICE_ACCOUNT('),
('      ''HR_ETL_SERVICE'',                -- account name'),
('      ''MIIBIjANBgkq...PUBLIC_KEY...'',  -- RSA public key'),
('      ''DEV'',                           -- environment'),
('      ''HR'',                            -- domain'),
('      ''DEVELOPER'',                     -- capability'),
('      ''DEV_WH'',                        -- warehouse'),
('      ''ETL service for loading HR data from source systems'','),
('      NULL                              -- optional second key for rotation'),
('  );'),
(''),
('STEP 3: GRANT ADDITIONAL ACCESS (if needed)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Service needs to read from STAGING domain too'),
('  CALL RBAC_GRANT_SERVICE_ACCOUNT('),
('      ''HR_ETL_SERVICE'','),
('      ''DEV'','),
('      ''STAGING'','),
('      ''ANALYST'',  -- read-only from staging'),
('      FALSE        -- dont change default role'),
('  );'),
(''),
('STEP 4: KEY ROTATION'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Rotate to new key'),
('  CALL RBAC_ROTATE_SERVICE_KEY('),
('      ''HR_ETL_SERVICE'','),
('      ''MIIBIjANBgkq...NEW_PUBLIC_KEY...'','),
('      1  -- key slot (1 or 2)'),
('  );'),
(''),
('CONNECTION STRING'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  Account: <your_account>'),
('  User: HR_ETL_SERVICE'),
('  Private Key: <path_to_rsa_key.p8>'),
('  Role: SRW_DEV_HR_DEVELOPER'),
('  Warehouse: DEV_WH'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- DEVOPS - Overview
    -- =========================================================================
    WHEN 'DEVOPS' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     DEVOPS & CI/CD OVERVIEW                                  ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('ARCHITECTURE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐'),
('  │ Azure DevOps │    │GitHub Actions│    │   GitLab     │'),
('  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘'),
('         │                   │                   │'),
('         └───────────────────┼───────────────────┘'),
('                             ▼'),
('              ┌──────────────────────────┐'),
('              │  SNOWFLAKE SERVICE ACCT  │'),
('              │  (DEPLOYER role)         │'),
('              └────────────┬─────────────┘'),
('                           │'),
('         ┌─────────────────┼─────────────────┐'),
('         ▼                 ▼                 ▼'),
('    ┌─────────┐       ┌─────────┐       ┌─────────┐'),
('    │   DEV   │  ───► │   TST   │  ───► │   PRD   │'),
('    └─────────┘       └─────────┘       └─────────┘'),
(''),
('KEY COMPONENTS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  1. PIPELINE SERVICE ACCOUNTS'),
('     - Dedicated service accounts for CI/CD pipelines'),
('     - RSA key-pair authentication (no passwords)'),
('     - SRW_*_DEPLOYER roles with scoped access'),
(''),
('  2. DEPLOYMENT TRACKING'),
('     - All deployments logged with metadata'),
('     - Audit trail for compliance'),
('     - Pipeline and commit tracking'),
(''),
('  3. ENVIRONMENT PROMOTION'),
('     - Controlled flow: DEV → TST → UAT → PRD'),
('     - Schema cloning or Git-based deployments'),
('     - Rollback support via Time Travel'),
(''),
('  4. GIT INTEGRATION'),
('     - Native Snowflake Git repository support'),
('     - Execute SQL directly from Git branches'),
('     - Automatic fetching and syncing'),
(''),
('SUPPORTED PLATFORMS'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  • Azure DevOps'),
('  • GitHub Actions'),
('  • GitLab CI/CD'),
('  • Any platform supporting Snowflake CLI'),
(''),
('─────────────────────────────────────────────────────────────────────────────────'),
('Topics: DEVOPS_SETUP, DEVOPS_GIT, DEVOPS_DEPLOY, DEVOPS_PROMOTE, DEVOPS_ROLLBACK')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- DEVOPS_SETUP - Pipeline Setup
    -- =========================================================================
    WHEN 'DEVOPS_SETUP' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     DEVOPS - PIPELINE SETUP                                  ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('STEP 1: GENERATE RSA KEY PAIR'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  # Generate private key'),
('  openssl genrsa 2048 | openssl pkcs8 -topk8 -inform PEM -out rsa_key.p8 -nocrypt'),
(''),
('  # Generate public key'),
('  openssl rsa -in rsa_key.p8 -pubout -out rsa_key.pub'),
(''),
('STEP 2: SETUP PIPELINE (Choose One)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  AZURE DEVOPS:'),
('  CALL DEVOPS_SETUP_AZURE_DEVOPS('),
('      ''MyProject'',                     -- project name'),
('      ''HR'',                            -- domain'),
('      ''MIIBIjAN...PUBLIC_KEY...'',      -- RSA public key'),
('      ARRAY_CONSTRUCT(''DEV'', ''TST'', ''PRD'')  -- environments'),
('  );'),
(''),
('  GITHUB ACTIONS:'),
('  CALL DEVOPS_SETUP_GITHUB_ACTIONS('),
('      ''my-repo'',                       -- repository name'),
('      ''HR'',                            -- domain'),
('      ''MIIBIjAN...PUBLIC_KEY...'',      -- RSA public key'),
('      ARRAY_CONSTRUCT(''DEV'', ''TST'', ''PRD'')'),
('  );'),
(''),
('  GITLAB:'),
('  CALL DEVOPS_SETUP_GITLAB('),
('      ''my-project'',                    -- project name'),
('      ''HR'',                            -- domain'),
('      ''MIIBIjAN...PUBLIC_KEY...'',      -- RSA public key'),
('      ARRAY_CONSTRUCT(''DEV'', ''TST'', ''PRD'')'),
('  );'),
(''),
('STEP 3: CONFIGURE CI/CD PLATFORM'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  The setup procedure returns:'),
('  • Service account name'),
('  • Required secrets/variables'),
('  • Sample pipeline YAML'),
(''),
('  Store in your platform:'),
('  • SNOWFLAKE_ACCOUNT    - Account identifier'),
('  • SNOWFLAKE_USER       - Service account name'),
('  • SNOWFLAKE_PRIVATE_KEY - RSA private key (secret)'),
('  • SNOWFLAKE_ROLE       - Deployer role'),
('  • SNOWFLAKE_WAREHOUSE  - Warehouse'),
(''),
('STEP 4: TEST CONNECTION'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  CALL DEVOPS_TEST_CONNECTION();'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- DEVOPS_GIT - Git Integration
    -- =========================================================================
    WHEN 'DEVOPS_GIT' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     DEVOPS - SNOWFLAKE GIT INTEGRATION                       ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('Snowflake supports native Git repository integration for:'),
('  • Storing SQL scripts in version control'),
('  • Executing SQL directly from Git branches'),
('  • Automatic syncing with remote repositories'),
(''),
('STEP 1: CREATE GIT CREDENTIALS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL DEVOPS_CREATE_GIT_SECRET('),
('      ''GITHUB_CREDS'',                  -- secret name'),
('      ''GITHUB'',                        -- provider'),
('      ''username'',                      -- git username'),
('      ''ghp_xxxxxxxxxxxx''               -- personal access token'),
('  );'),
(''),
('STEP 2: SETUP GIT REPOSITORY'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL DEVOPS_SETUP_GIT_REPOSITORY('),
('      ''MY_REPO'',                        -- repository name in Snowflake'),
('      ''https://github.com/org/repo.git'',-- git URL'),
('      ''GITHUB'',                         -- provider: GITHUB, GITLAB, AZURE_DEVOPS'),
('      ''GITHUB_CREDS'',                   -- secret name'),
('      NULL,                              -- API integration (auto-created)'),
('      ''main''                            -- default branch'),
('  );'),
(''),
('USING GIT REPOSITORY'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- List branches'),
('  SHOW GIT BRANCHES IN MY_REPO;'),
(''),
('  -- List files in branch'),
('  LS @MY_REPO/branches/main;'),
(''),
('  -- Execute SQL from Git'),
('  EXECUTE IMMEDIATE FROM @MY_REPO/branches/main/deploy/tables.sql;'),
(''),
('  -- Fetch latest changes'),
('  ALTER GIT REPOSITORY MY_REPO FETCH;'),
(''),
('  -- Deploy from Git with tracking'),
('  CALL DEVOPS_DEPLOY_FROM_GIT('),
('      ''MY_REPO'',                        -- repository'),
('      ''main'',                           -- branch'),
('      ''deploy/schema.sql'',              -- file path'),
('      ''DEV'',                            -- target environment'),
('      ''HR''                              -- database name'),
('  );'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- DEVOPS_DEPLOY - Deployment Tracking
    -- =========================================================================
    WHEN 'DEVOPS_DEPLOY' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     DEVOPS - DEPLOYMENT TRACKING                             ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('All deployments are tracked in DEVOPS_DEPLOYMENTS table'),
(''),
('MANUAL DEPLOYMENT TRACKING'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Start deployment'),
('  CALL DEVOPS_START_DEPLOYMENT('),
('      ''DEV'',                            -- target environment'),
('      ''HR'',                             -- database'),
('      ''EMPLOYEES'',                      -- schema'),
('      ''SCHEMA'',                         -- deployment type'),
('      ''AZURE_DEVOPS'',                   -- pipeline name'),
('      ''12345'',                          -- pipeline run ID'),
('      ''abc123'',                         -- commit SHA'),
('      ''main'',                           -- branch'),
('      NULL                               -- metadata'),
('  );'),
('  -- Returns: deployment_id'),
(''),
('  -- Log individual objects'),
('  CALL DEVOPS_LOG_DEPLOYMENT_OBJECT('),
('      ''<deployment_id>'','),
('      ''TABLE'','),
('      ''EMPLOYEES'','),
('      ''CREATE'','),
('      ''CREATE TABLE EMPLOYEES (...)'''),
('  );'),
(''),
('  -- Complete deployment'),
('  CALL DEVOPS_COMPLETE_DEPLOYMENT(''<deployment_id>'', ''SUCCESS'', NULL);'),
(''),
('AUTOMATED DEPLOYMENT FROM GIT'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Single command deployment with tracking'),
('  CALL DEVOPS_DEPLOY_FROM_GIT('),
('      ''MY_REPO'',                        -- repository'),
('      ''main'',                           -- branch'),
('      ''deploy/v1.0/tables.sql'',         -- file path'),
('      ''DEV'',                            -- environment'),
('      ''HR'',                             -- database'),
('      ''EMPLOYEES''                       -- schema'),
('  );'),
(''),
('VIEW DEPLOYMENT HISTORY'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Recent deployments'),
('  CALL DEVOPS_GET_DEPLOYMENT_HISTORY(''DEV'', NULL, 30, NULL);'),
(''),
('  -- Deployment details'),
('  CALL DEVOPS_GET_DEPLOYMENT_DETAILS(''<deployment_id>'');'),
(''),
('  -- Deployment report'),
('  CALL DEVOPS_GENERATE_DEPLOYMENT_REPORT(''2024-01-01'', ''2024-12-31'');'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- DEVOPS_PROMOTE - Environment Promotion
    -- =========================================================================
    WHEN 'DEVOPS_PROMOTE' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     DEVOPS - ENVIRONMENT PROMOTION                           ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('PROMOTION PATHS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  Standard: DEV → TST → UAT → PPE → PRD'),
('  Fast:     DEV → UAT → PRD'),
(''),
('METHOD 1: SCHEMA CLONE (Data + Structure)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Clone schema from DEV to TST (structure only)'),
('  CALL DEVOPS_CLONE_SCHEMA('),
('      ''DEV'',                            -- source environment'),
('      ''TST'',                            -- target environment'),
('      ''HR'',                             -- database name'),
('      ''EMPLOYEES'',                      -- schema name'),
('      FALSE                              -- include data (FALSE = structure only)'),
('  );'),
(''),
('  -- Clone with data (for test data)'),
('  CALL DEVOPS_CLONE_SCHEMA(''DEV'', ''TST'', ''HR'', ''TEST_DATA'', TRUE);'),
(''),
('METHOD 2: GIT-BASED DEPLOYMENT (Recommended)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Deploy same SQL to TST from Git'),
('  CALL DEVOPS_DEPLOY_FROM_GIT('),
('      ''MY_REPO'','),
('      ''release/v1.0'',                   -- release branch'),
('      ''deploy/schema.sql'','),
('      ''TST'',                            -- target: TST'),
('      ''HR'','),
('      ''EMPLOYEES'''),
('  );'),
(''),
('  -- Later, deploy to PRD'),
('  CALL DEVOPS_DEPLOY_FROM_GIT('),
('      ''MY_REPO'','),
('      ''release/v1.0'',                   -- same release'),
('      ''deploy/schema.sql'','),
('      ''PRD'',                            -- target: PRD'),
('      ''HR'','),
('      ''EMPLOYEES'''),
('  );'),
(''),
('METHOD 3: PROMOTION PREVIEW'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- See what would be promoted (dry run)'),
('  CALL DEVOPS_PROMOTE_SCHEMA('),
('      ''DEV'',                            -- source'),
('      ''TST'',                            -- target'),
('      ''HR'','),
('      ''EMPLOYEES'','),
('      ARRAY_CONSTRUCT(''TABLE'', ''VIEW''), -- object types'),
('      TRUE                               -- dry run'),
('  );'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- DEVOPS_ROLLBACK
    -- =========================================================================
    WHEN 'DEVOPS_ROLLBACK' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     DEVOPS - ROLLBACK PROCEDURES                             ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('ROLLBACK OPTIONS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  1. TIME TRAVEL   - Restore to point in time'),
('  2. UNDROP        - Recover dropped objects'),
('  3. GIT REDEPLOY  - Re-deploy from previous commit'),
(''),
('OPTION 1: ROLLBACK USING TIME TRAVEL'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Get deployment info'),
('  CALL DEVOPS_GET_DEPLOYMENT_DETAILS(''<deployment_id>'');'),
(''),
('  -- Initiate rollback'),
('  CALL DEVOPS_ROLLBACK_DEPLOYMENT('),
('      ''<deployment_id>'',                -- deployment to rollback'),
('      ''TIME_TRAVEL'',                    -- method'),
('      ''2024-01-15 10:00:00''::TIMESTAMP  -- point in time (optional)'),
('  );'),
(''),
('  -- Manual Time Travel for tables'),
('  CREATE OR REPLACE TABLE HR_DEV.EMPLOYEES.STAFF'),
('  CLONE HR_DEV.EMPLOYEES.STAFF AT(TIMESTAMP => ''2024-01-15 10:00:00''::TIMESTAMP);'),
(''),
('OPTION 2: UNDROP OBJECTS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Undrop table'),
('  UNDROP TABLE HR_DEV.EMPLOYEES.STAFF;'),
(''),
('  -- Undrop schema'),
('  UNDROP SCHEMA HR_DEV.EMPLOYEES;'),
(''),
('OPTION 3: GIT REDEPLOY'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Find previous working commit'),
('  -- (Check Git history in your repository)'),
(''),
('  -- Deploy from previous commit'),
('  CALL DEVOPS_DEPLOY_FROM_GIT('),
('      ''MY_REPO'','),
('      ''commit/abc123def'',               -- previous commit'),
('      ''deploy/schema.sql'','),
('      ''DEV'','),
('      ''HR'','),
('      ''EMPLOYEES'''),
('  );'),
(''),
('BEST PRACTICES'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  • Always use deployment tracking for audit trail'),
('  • Set appropriate DATA_RETENTION_TIME_IN_DAYS'),
('  • Test rollback procedures in non-production'),
('  • Keep deployment scripts idempotent'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- EXAMPLE_DEVOPS
    -- =========================================================================
    WHEN 'EXAMPLE_DEVOPS' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     EXAMPLE: CI/CD PIPELINE SETUP                            ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('SCENARIO: Setup GitHub Actions pipeline for HR domain deployment'),
(''),
('STEP 1: GENERATE RSA KEYS (Local Machine)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  # Terminal commands'),
('  openssl genrsa 2048 | openssl pkcs8 -topk8 -inform PEM -out rsa_key.p8 -nocrypt'),
('  openssl rsa -in rsa_key.p8 -pubout -out rsa_key.pub'),
('  cat rsa_key.pub'),
(''),
('STEP 2: SETUP GITHUB ACTIONS IN SNOWFLAKE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  USE ROLE SRS_SECURITY_ADMIN;'),
(''),
('  CALL DEVOPS_SETUP_GITHUB_ACTIONS('),
('      ''hr-data-pipelines'',             -- repo name'),
('      ''HR'',                            -- domain'),
('      ''MIIBIjANBgkqhkiG9...'',          -- public key from step 1'),
('      ARRAY_CONSTRUCT(''DEV'', ''TST'', ''PRD'')'),
('  );'),
(''),
('  -- Save the returned configuration'),
(''),
('STEP 3: CONFIGURE GITHUB SECRETS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  In GitHub → Settings → Secrets → Actions:'),
(''),
('  SNOWFLAKE_ACCOUNT     = <your-account>'),
('  SNOWFLAKE_USER        = GITHUB_HR_DATA_PIPELINES_HR_DEPLOYER'),
('  SNOWFLAKE_PRIVATE_KEY = <contents of rsa_key.p8, base64 encoded>'),
('  SNOWFLAKE_ROLE        = SRW_DEV_HR_DEVELOPER'),
('  SNOWFLAKE_WAREHOUSE   = DEV_WH'),
(''),
('STEP 4: CREATE WORKFLOW FILE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  # .github/workflows/deploy.yml'),
('  name: Deploy to Snowflake'),
('  on:'),
('    push:'),
('      branches: [main, develop]'),
(''),
('  jobs:'),
('    deploy:'),
('      runs-on: ubuntu-latest'),
('      steps:'),
('        - uses: actions/checkout@v4'),
('        - uses: Snowflake-Labs/snowflake-cli-action@v1'),
('        - run: snow sql -f deploy.sql'),
(''),
('STEP 5: SETUP NATIVE GIT INTEGRATION (Optional)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create secret for Git access'),
('  CALL DEVOPS_CREATE_GIT_SECRET('),
('      ''GITHUB_HR_CREDS'','),
('      ''GITHUB'','),
('      ''your-github-username'','),
('      ''ghp_your_personal_access_token'''),
('  );'),
(''),
('  -- Setup repository'),
('  CALL DEVOPS_SETUP_GIT_REPOSITORY('),
('      ''HR_PIPELINES_REPO'','),
('      ''https://github.com/yourorg/hr-data-pipelines.git'','),
('      ''GITHUB'','),
('      ''GITHUB_HR_CREDS'','),
('      NULL,'),
('      ''main'''),
('  );'),
(''),
('STEP 6: DEPLOY FROM SNOWFLAKE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Deploy directly from Git repository'),
('  CALL DEVOPS_DEPLOY_FROM_GIT('),
('      ''HR_PIPELINES_REPO'','),
('      ''main'','),
('      ''deploy/tables.sql'','),
('      ''DEV'','),
('      ''HR'','),
('      ''EMPLOYEES'''),
('  );'),
(''),
('STEP 7: VERIFY DEPLOYMENT'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Check deployment history'),
('  CALL DEVOPS_GET_DEPLOYMENT_HISTORY(''DEV'', ''HR'', 7, NULL);'),
(''),
('  -- Test connection'),
('  CALL DEVOPS_TEST_CONNECTION();'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- CLONES - Overview
    -- =========================================================================
    WHEN 'CLONES' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     CLONE MANAGEMENT OVERVIEW                                ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('PURPOSE'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  Provides controlled database/schema cloning with:'),
('  • Clone limits per user (default: 3 per environment)'),
('  • RBAC security maintained (DBADMIN retains ownership)'),
('  • User access via dedicated database roles'),
('  • Optional expiration dates'),
('  • Full audit trail'),
(''),
('OWNERSHIP MODEL'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  ┌─────────────────────────────────────────────────────────────────────────┐'),
('  │  Clone ownership → SRF_*_DBADMIN (NOT the user)                         │'),
('  │  User access     → Dedicated SRD_* database role                        │'),
('  │  Security        → Users cannot grant access to others                  │'),
('  │  Management      → DBADMIN can revoke, delete, audit all clones         │'),
('  └─────────────────────────────────────────────────────────────────────────┘'),
(''),
('DEFAULT LIMITS BY ENVIRONMENT'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  | Environment | Max Clones | Expiry Days | DB Clone | Schema Clone |'),
('  |-------------|------------|-------------|----------|--------------|'),
('  | DEV         | 5          | None        | Yes      | Yes          |'),
('  | TST         | 3          | 30          | No       | Yes          |'),
('  | UAT         | 2          | 14          | No       | Yes          |'),
('  | PPE         | 1          | 7           | No       | Yes          |'),
('  | PRD         | 1          | 7           | No       | Yes          |'),
(''),
('QUICK REFERENCE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create a clone'),
('  CALL RBAC_CREATE_CLONE(''DEV'', ''HR'', ''EMPLOYEES'', ''SCHEMA'', TRUE, NULL);'),
(''),
('  -- List your clones'),
('  CALL RBAC_LIST_USER_CLONES();'),
(''),
('  -- Delete a clone'),
('  CALL RBAC_DELETE_CLONE(''<clone_id>'');'),
(''),
('  -- Replace oldest clone with new one'),
('  CALL RBAC_REPLACE_CLONE(''DEV'', ''HR'', ''EMPLOYEES'', ''SCHEMA'', TRUE, TRUE, NULL);'),
(''),
('─────────────────────────────────────────────────────────────────────────────────'),
('Topics: CLONE_CREATE, CLONE_MANAGE, EXAMPLE_CLONE')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- CLONE_CREATE
    -- =========================================================================
    WHEN 'CLONE_CREATE' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     CLONE CREATION                                           ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('RBAC_CREATE_CLONE PROCEDURE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL RBAC_CREATE_CLONE('),
('      P_ENVIRONMENT,       -- DEV, TST, UAT, PPE, PRD'),
('      P_SOURCE_DATABASE,   -- Source database (without env suffix)'),
('      P_SOURCE_SCHEMA,     -- Source schema (NULL for database clone)'),
('      P_CLONE_TYPE,        -- ''SCHEMA'' or ''DATABASE'''),
('      P_INCLUDE_DATA,      -- TRUE = with data, FALSE = structure only'),
('      P_CLONE_SUFFIX       -- Optional custom suffix (auto-numbered if NULL)'),
('  );'),
(''),
('EXAMPLE: Schema Clone'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL RBAC_CREATE_CLONE('),
('      ''DEV'',              -- environment'),
('      ''HR'',               -- source database (becomes HR_DEV)'),
('      ''EMPLOYEES'',        -- source schema'),
('      ''SCHEMA'',           -- clone type'),
('      TRUE,                -- include data'),
('      NULL                 -- auto-number'),
('  );'),
(''),
('  Result:'),
('    Clone: HR_DEV.EMPLOYEES_CLONE_JOHNDOE_1'),
('    Role:  SRD_HR_DEV_EMPLOYEES_CLONE_JOHNDOE_1_WRITE'),
('    Access: Automatically granted to you'),
(''),
('CLONE NAMING'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  Schema Clone:   <DB>_<ENV>.<SCHEMA>_CLONE_<USER>_<NUM>'),
('  Database Clone: <DB>_<ENV>_CLONE_<USER>_<NUM>'),
('  Database Role:  SRD_<DB>_<ENV>_<SCHEMA>_CLONE_<USER>_<NUM>_<RW>'),
(''),
('WHEN LIMIT IS REACHED'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  If you have 3 clones (limit) and try to create another:'),
(''),
('  Error: "Clone limit reached. You have 3 of 3 allowed clones in DEV"'),
('  Returns: List of your current clones'),
('  Action:  Delete a clone first, or use RBAC_REPLACE_CLONE()'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- CLONE_MANAGE
    -- =========================================================================
    WHEN 'CLONE_MANAGE' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     CLONE MANAGEMENT                                         ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('LIST YOUR CLONES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- All your clones'),
('  CALL RBAC_LIST_USER_CLONES();'),
(''),
('  -- Filter by environment'),
('  CALL RBAC_LIST_USER_CLONES(''DEV'', NULL);'),
(''),
('DELETE A CLONE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- By clone ID (from list)'),
('  CALL RBAC_DELETE_CLONE(''abc123-def456-...'');'),
(''),
('  -- By clone name'),
('  CALL RBAC_DELETE_CLONE(''HR_DEV.EMPLOYEES_CLONE_JOHNDOE_1'');'),
(''),
('REPLACE A CLONE (When at limit)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Replace oldest clone automatically'),
('  CALL RBAC_REPLACE_CLONE('),
('      ''DEV'',              -- environment'),
('      ''HR'',               -- database'),
('      ''EMPLOYEES'',        -- schema'),
('      ''SCHEMA'',           -- clone type'),
('      TRUE,                -- include data'),
('      TRUE,                -- replace oldest'),
('      NULL                 -- or specify clone ID to replace'),
('  );'),
(''),
('  -- Specify which clone to replace'),
('  CALL RBAC_REPLACE_CLONE('),
('      ''DEV'', ''HR'', ''EMPLOYEES'', ''SCHEMA'', TRUE,'),
('      FALSE,               -- dont auto-select oldest'),
('      ''abc123-def456''    -- specific clone to replace'),
('  );'),
(''),
('VIEW CLONE LIMITS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL RBAC_GET_CLONE_LIMITS();'),
(''),
('ADMIN PROCEDURES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- List all clones (admin)'),
('  CALL RBAC_LIST_ALL_CLONES(NULL, ''ACTIVE'');'),
(''),
('  -- Cleanup expired clones'),
('  CALL RBAC_CLEANUP_EXPIRED_CLONES(NULL, TRUE);  -- dry run'),
('  CALL RBAC_CLEANUP_EXPIRED_CLONES(NULL, FALSE); -- execute'),
(''),
('  -- Get summary'),
('  CALL RBAC_GET_CLONE_SUMMARY();'),
(''),
('  -- Change limits'),
('  CALL RBAC_SET_CLONE_LIMIT(''DEV'', 10, NULL, TRUE, TRUE);'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- EXAMPLE_CLONE
    -- =========================================================================
    WHEN 'EXAMPLE_CLONE' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     EXAMPLE: CLONE MANAGEMENT                                ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('SCENARIO: Developer needs isolated copy of EMPLOYEES schema for testing'),
(''),
('STEP 1: CHECK CLONE LIMITS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL RBAC_GET_CLONE_LIMITS();'),
(''),
('  Result:'),
('  | ENVIRONMENT | MAX_CLONES_PER_USER | CLONE_EXPIRY_DAYS |'),
('  |-------------|---------------------|-------------------|'),
('  | DEV         | 5                   | NULL              |'),
('  | TST         | 3                   | 30                |'),
(''),
('STEP 2: CREATE FIRST CLONE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL RBAC_CREATE_CLONE(''DEV'', ''HR'', ''EMPLOYEES'', ''SCHEMA'', TRUE, NULL);'),
(''),
('  Result:'),
('  {'),
('    "status": "SUCCESS",'),
('    "clone_name": "HR_DEV.EMPLOYEES_CLONE_JOHNDOE_1",'),
('    "database_role": "SRD_HR_DEV_EMPLOYEES_CLONE_JOHNDOE_1_WRITE",'),
('    "clones_used": 1,'),
('    "clones_max": 5'),
('  }'),
(''),
('STEP 3: USE THE CLONE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  USE SCHEMA HR_DEV.EMPLOYEES_CLONE_JOHNDOE_1;'),
(''),
('  -- Your changes are isolated from the source'),
('  UPDATE STAFF SET SALARY = SALARY * 1.1;  -- Only affects your clone'),
(''),
('STEP 4: VIEW YOUR CLONES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL RBAC_LIST_USER_CLONES();'),
(''),
('  Result:'),
('  | CLONE_NAME                           | CREATED_AT          | EXPIRES_AT |'),
('  |--------------------------------------|---------------------|------------|'),
('  | HR_DEV.EMPLOYEES_CLONE_JOHNDOE_1     | 2024-01-15 10:00:00 | NULL       |'),
(''),
('STEP 5: CREATE MORE CLONES (Up to Limit)'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL RBAC_CREATE_CLONE(''DEV'', ''HR'', ''PAYROLL'', ''SCHEMA'', TRUE, NULL);'),
('  CALL RBAC_CREATE_CLONE(''DEV'', ''SALES'', ''ORDERS'', ''SCHEMA'', FALSE, NULL);'),
(''),
('STEP 6: WHEN AT LIMIT - REPLACE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- At 5 clones, want to create another'),
('  CALL RBAC_CREATE_CLONE(''DEV'', ''FINANCE'', ''ACCOUNTS'', ''SCHEMA'', TRUE, NULL);'),
(''),
('  Error: "Clone limit reached. You have 5 of 5 allowed clones in DEV"'),
(''),
('  -- Option 1: Delete specific clone'),
('  CALL RBAC_DELETE_CLONE(''HR_DEV.EMPLOYEES_CLONE_JOHNDOE_1'');'),
('  CALL RBAC_CREATE_CLONE(''DEV'', ''FINANCE'', ''ACCOUNTS'', ''SCHEMA'', TRUE, NULL);'),
(''),
('  -- Option 2: Replace oldest automatically'),
('  CALL RBAC_REPLACE_CLONE(''DEV'', ''FINANCE'', ''ACCOUNTS'', ''SCHEMA'', TRUE, TRUE, NULL);'),
(''),
('STEP 7: CLEANUP WHEN DONE'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Delete clone when no longer needed'),
('  CALL RBAC_DELETE_CLONE(''HR_DEV.EMPLOYEES_CLONE_JOHNDOE_1'');'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- CLONE_AUDIT
    -- =========================================================================
    WHEN 'CLONE_AUDIT' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     CLONE AUDIT & COMPLIANCE                                 ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('PURPOSE'),
('─────────────────────────────────────────────────────────────────────────────────'),
('  • Full audit trail of all clone operations'),
('  • Compliance policy enforcement'),
('  • Policy violation tracking and resolution'),
('  • Usage pattern analysis'),
(''),
('AUDIT TABLES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  RBAC_CLONE_AUDIT_LOG         - All clone operations (create, delete, etc.)'),
('  RBAC_CLONE_POLICIES          - Compliance policy definitions'),
('  RBAC_CLONE_POLICY_VIOLATIONS - Logged policy violations'),
('  RBAC_CLONE_ACCESS_LOG        - Who accessed what clones'),
(''),
('VIEW AUDIT LOG'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Last 30 days of clone operations'),
('  CALL RBAC_GET_CLONE_AUDIT_LOG(NULL, NULL, NULL, NULL, NULL, 1000);'),
(''),
('  -- Filter by operation type'),
('  CALL RBAC_GET_CLONE_AUDIT_LOG(NULL, NULL, ''CREATE'', NULL, ''DEV'', 100);'),
(''),
('  -- Filter by user'),
('  CALL RBAC_GET_CLONE_AUDIT_LOG(''2024-01-01'', ''2024-12-31'', NULL, ''john.doe@company.com'', NULL, 500);'),
(''),
('COMPLIANCE REPORTS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Generate full audit report'),
('  CALL RBAC_GENERATE_CLONE_AUDIT_REPORT(''2024-01-01'', ''2024-12-31'');'),
(''),
('  -- Check all clones for policy compliance'),
('  CALL RBAC_CHECK_CLONE_COMPLIANCE(NULL);  -- All environments'),
('  CALL RBAC_CHECK_CLONE_COMPLIANCE(''PRD''); -- PRD only'),
(''),
('  -- View your own activity'),
('  CALL RBAC_GET_USER_CLONE_ACTIVITY(NULL, 30);'),
(''),
('POLICY VIOLATIONS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- View open violations'),
('  CALL RBAC_GET_POLICY_VIOLATIONS(''OPEN'', NULL, NULL, NULL);'),
(''),
('  -- View critical violations'),
('  CALL RBAC_GET_POLICY_VIOLATIONS(NULL, ''CRITICAL'', NULL, NULL);'),
(''),
('  -- Resolve a violation'),
('  CALL RBAC_RESOLVE_POLICY_VIOLATION(''<violation_id>'', ''Clone deleted per policy'');'),
(''),
('─────────────────────────────────────────────────────────────────────────────────'),
('Topics: CLONE_POLICIES, CLONES, CLONE_MANAGE')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- CLONE_POLICIES
    -- =========================================================================
    WHEN 'CLONE_POLICIES' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     CLONE COMPLIANCE POLICIES                                ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('POLICY TYPES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  | Type                    | Purpose                                         |'),
('  |-------------------------|------------------------------------------------|'),
('  | MAX_AGE                 | Maximum age for clones                         |'),
('  | RESTRICTED_SOURCE       | Sources that cannot be cloned                  |'),
('  | DATA_CLASSIFICATION     | Restrict based on data classification          |'),
('  | USER_QUOTA              | Total clone limit per user                     |'),
('  | ENVIRONMENT_RESTRICTION | Environment-specific rules                     |'),
('  | TIME_RESTRICTION        | Time-based restrictions (business hours)       |'),
('  | SENSITIVE_DATA          | Restrictions on PII/PHI/PCI schemas            |'),
('  | APPROVAL_REQUIRED       | Require approval for certain clones            |'),
(''),
('SEVERITY LEVELS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  INFO     - Informational, logged only'),
('  WARNING  - Warning logged, clone allowed'),
('  ERROR    - Clone blocked, violation logged'),
('  CRITICAL - Clone blocked, alert triggered'),
(''),
('SETUP DEFAULT POLICIES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create recommended default policies'),
('  CALL RBAC_SETUP_DEFAULT_CLONE_POLICIES();'),
(''),
('  Default policies include:'),
('  • PRD_MAX_CLONE_AGE_7_DAYS'),
('  • UAT_MAX_CLONE_AGE_14_DAYS'),
('  • RESTRICT_PII_SCHEMA_CLONES'),
('  • NO_PRD_DATABASE_CLONES'),
('  • PRD_BUSINESS_HOURS_ONLY'),
('  • MAX_TOTAL_USER_CLONES_10'),
(''),
('CREATE CUSTOM POLICY'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Example: Max age policy'),
('  CALL RBAC_CREATE_CLONE_POLICY('),
('      ''DEV_MAX_CLONE_AGE_30_DAYS'','),
('      ''MAX_AGE'','),
('      ''DEV'','),
('      ''DEV clones must not exceed 30 days'','),
('      OBJECT_CONSTRUCT(''max_age_days'', 30, ''action'', ''WARN_AND_LOG''),'),
('      ''WARNING'''),
('  );'),
(''),
('  -- Example: Sensitive data restriction'),
('  CALL RBAC_CREATE_CLONE_POLICY('),
('      ''NO_SALARY_CLONES'','),
('      ''SENSITIVE_DATA'','),
('      NULL,  -- All environments'),
('      ''Salary data cannot be cloned'','),
('      OBJECT_CONSTRUCT('),
('          ''restricted_schemas'', ARRAY_CONSTRUCT(''SALARY'', ''COMPENSATION''),'),
('          ''action'', ''BLOCK'''),
('      ),'),
('      ''ERROR'''),
('  );'),
(''),
('MANAGE POLICIES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- List all policies'),
('  CALL RBAC_LIST_CLONE_POLICIES(NULL, NULL, TRUE);'),
(''),
('  -- Disable a policy'),
('  CALL RBAC_SET_POLICY_STATUS(''PRD_BUSINESS_HOURS_ONLY'', FALSE);'),
(''),
('  -- Delete a policy'),
('  CALL RBAC_DELETE_CLONE_POLICY(''OLD_POLICY_NAME'');'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- MONITORING - Overview
    -- =========================================================================
    WHEN 'MONITORING' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     MONITORING DASHBOARDS OVERVIEW                           ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('AVAILABLE DASHBOARDS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  ┌─────────────────────────────────────────────────────────────────────────┐'),
('  │ SECURITY MONITORING                                                      │'),
('  │   CALL RBAC_SECURITY_MONITORING_DASHBOARD();                            │'),
('  │   → Role assignments, anomalies, misalignments, alerts, exceptions      │'),
('  ├─────────────────────────────────────────────────────────────────────────┤'),
('  │ CLONE MONITORING                                                         │'),
('  │   CALL RBAC_CLONE_MONITORING_DASHBOARD();                               │'),
('  │   → Clone usage, storage costs, compliance, trends                      │'),
('  ├─────────────────────────────────────────────────────────────────────────┤'),
('  │ DEVOPS MONITORING                                                        │'),
('  │   CALL RBAC_DEVOPS_MONITORING_DASHBOARD();                              │'),
('  │   → Pipelines, deployments, releases, git, failures                     │'),
('  └─────────────────────────────────────────────────────────────────────────┘'),
(''),
('INDIVIDUAL DASHBOARDS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  Security:'),
('    RBAC_ROLE_ASSIGNMENT_DASHBOARD()'),
('    RBAC_ACCESS_ANOMALY_DASHBOARD(days_back)'),
('    RBAC_CONFIG_MISALIGNMENT_DASHBOARD()'),
('    RBAC_SECURITY_ALERTS_DASHBOARD()'),
('    RBAC_SECURITY_EXCEPTIONS_DASHBOARD()'),
(''),
('  Clone:'),
('    RBAC_CLONE_USAGE_DASHBOARD()'),
('    RBAC_CLONE_STORAGE_DASHBOARD(cost_per_tb)'),
('    RBAC_CLONE_COMPLIANCE_DASHBOARD()'),
('    RBAC_CLONE_TRENDS_DASHBOARD(days_back)'),
(''),
('  DevOps:'),
('    RBAC_PIPELINE_STATUS_DASHBOARD()'),
('    RBAC_DEPLOYMENT_TRACKING_DASHBOARD(days_back)'),
('    RBAC_RELEASE_MANAGEMENT_DASHBOARD()'),
('    RBAC_GIT_INTEGRATION_DASHBOARD()'),
('    RBAC_CHANGE_ANALYTICS_DASHBOARD(days_back)'),
('    RBAC_DEPLOYMENT_FAILURE_DASHBOARD(days_back)'),
(''),
('─────────────────────────────────────────────────────────────────────────────────'),
('Topics: MON_SECURITY, MON_CLONES, MON_DEVOPS')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- MON_SECURITY
    -- =========================================================================
    WHEN 'MON_SECURITY' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     SECURITY MONITORING DASHBOARD                            ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('UNIFIED DASHBOARD'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL RBAC_SECURITY_MONITORING_DASHBOARD();'),
(''),
('  Returns:'),
('    • overall_health     - HEALTHY, WARNING, or CRITICAL'),
('    • critical_issues    - List of critical issues requiring attention'),
('    • quick_stats        - Summary counts for all security metrics'),
('    • role_assignments   - Full role assignment analysis'),
('    • access_anomalies   - Unusual access patterns detected'),
('    • config_misalignments - RBAC configuration issues'),
('    • security_alerts    - Open security alerts'),
('    • security_exceptions - Active exceptions'),
(''),
('INDIVIDUAL DASHBOARDS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Role assignments and hierarchy'),
('  CALL RBAC_ROLE_ASSIGNMENT_DASHBOARD();'),
(''),
('  -- Access anomalies (unusual patterns)'),
('  CALL RBAC_ACCESS_ANOMALY_DASHBOARD(7);  -- Last 7 days'),
(''),
('  -- Configuration misalignments'),
('  CALL RBAC_CONFIG_MISALIGNMENT_DASHBOARD();'),
(''),
('  -- Security alerts'),
('  CALL RBAC_SECURITY_ALERTS_DASHBOARD();'),
(''),
('  -- Active exceptions'),
('  CALL RBAC_SECURITY_EXCEPTIONS_DASHBOARD();'),
(''),
('AUTOMATED SECURITY SCAN'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Run automated scan (creates alerts for issues found)'),
('  CALL RBAC_RUN_SECURITY_SCAN();'),
(''),
('ALERT MANAGEMENT'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Acknowledge an alert'),
('  CALL RBAC_RESOLVE_SECURITY_ALERT(''<alert_id>'', ''ACKNOWLEDGE'', NULL);'),
(''),
('  -- Resolve an alert'),
('  CALL RBAC_RESOLVE_SECURITY_ALERT(''<alert_id>'', ''RESOLVE'', ''Issue fixed'');'),
(''),
('EXCEPTION MANAGEMENT'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create exception for temporary elevated access'),
('  CALL RBAC_CREATE_SECURITY_EXCEPTION('),
('      ''ELEVATED_ACCESS'',     -- type'),
('      ''john.doe@company.com'',-- user'),
('      ''SRS_SYSTEM_ADMIN'',    -- role'),
('      ''PRD'',                 -- environment'),
('      ''Emergency fix for production issue'','),
('      7,                      -- expires in days'),
('      ''INC0012345''          -- ticket number'),
('  );'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- MON_CLONES
    -- =========================================================================
    WHEN 'MON_CLONES' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     CLONE MONITORING DASHBOARD                               ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('UNIFIED DASHBOARD'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL RBAC_CLONE_MONITORING_DASHBOARD();'),
(''),
('  Returns:'),
('    • health_status      - HEALTHY, ATTENTION, WARNING, or CRITICAL'),
('    • alerts             - Issues requiring attention'),
('    • quick_stats        - Total clones, compliance %, expiring soon'),
('    • usage              - Full usage breakdown'),
('    • compliance         - Policy compliance status'),
(''),
('INDIVIDUAL DASHBOARDS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Clone usage overview'),
('  CALL RBAC_CLONE_USAGE_DASHBOARD();'),
('  → Active clones by environment, type, user'),
('  → Recent activity, expiring clones'),
(''),
('  -- Storage cost analysis'),
('  CALL RBAC_CLONE_STORAGE_DASHBOARD(23.00);  -- $23/TB/month'),
('  → Estimated storage consumption'),
('  → Cost by environment and user'),
(''),
('  -- Policy compliance status'),
('  CALL RBAC_CLONE_COMPLIANCE_DASHBOARD();'),
('  → Compliance percentage'),
('  → Open violations by severity'),
('  → Policy summary'),
(''),
('  -- Clone activity trends'),
('  CALL RBAC_CLONE_TRENDS_DASHBOARD(30);  -- Last 30 days'),
('  → Daily/weekly activity'),
('  → User and environment trends'),
('  → Peak usage hours'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- MON_DEVOPS
    -- =========================================================================
    WHEN 'MON_DEVOPS' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     DEVOPS MONITORING DASHBOARD                              ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('UNIFIED DASHBOARD'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  CALL RBAC_DEVOPS_MONITORING_DASHBOARD();'),
(''),
('  Returns:'),
('    • overall_health     - ALL_HEALTHY, HEALTHY, DEGRADED, or WARNING'),
('    • alerts             - Issues requiring attention'),
('    • quick_stats        - Deployments, success rate, pipelines, releases'),
('    • pipelines          - Pipeline status dashboard'),
('    • deployments        - Deployment tracking dashboard'),
('    • releases           - Release management dashboard'),
('    • git                - Git integration dashboard'),
('    • failures           - Failure analysis dashboard'),
(''),
('INDIVIDUAL DASHBOARDS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Pipeline status'),
('  CALL RBAC_PIPELINE_STATUS_DASHBOARD();'),
('  → Active pipelines and health status'),
('  → Failing pipelines'),
('  → Recent pipeline runs'),
(''),
('  -- Deployment tracking'),
('  CALL RBAC_DEPLOYMENT_TRACKING_DASHBOARD(30);'),
('  → Deployments by environment, status'),
('  → Daily trends and velocity'),
(''),
('  -- Release management'),
('  CALL RBAC_RELEASE_MANAGEMENT_DASHBOARD();'),
('  → Current versions by environment'),
('  → Recent releases and rollbacks'),
('  → Release frequency'),
(''),
('  -- Git integration'),
('  CALL RBAC_GIT_INTEGRATION_DASHBOARD();'),
('  → Registered repositories'),
('  → Branch activity'),
('  → Commit statistics'),
(''),
('  -- Change analytics'),
('  CALL RBAC_CHANGE_ANALYTICS_DASHBOARD(30);'),
('  → Changes by type, environment, object'),
('  → Breaking changes'),
('  → Top changed objects'),
(''),
('  -- Failure analysis'),
('  CALL RBAC_DEPLOYMENT_FAILURE_DASHBOARD(30);'),
('  → Failure rate by environment/pipeline'),
('  → Recent failures with details'),
('  → Failure trends'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- GOVERNANCE
    -- =========================================================================
    WHEN 'GOVERNANCE' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     DATA GOVERNANCE                                          ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('OVERVIEW'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  The Data Governance module provides:'),
('    • Row-Level Security (RLS) - Control row visibility by user context'),
('    • Dynamic Data Masking    - Obfuscate sensitive data'),
('    • Data Classification     - Tag and categorize sensitive columns'),
('    • Governance Tags         - Apply metadata tags to objects'),
(''),
('SCHEMA LOCATION: ADMIN.GOVERNANCE'),
(''),
('ROW ACCESS POLICIES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create a row access policy'),
('  CALL RBAC_CREATE_ROW_ACCESS_POLICY('),
('      ''ENV_FILTER'',           -- Policy name'),
('      ''ADMIN'', ''GOVERNANCE'', -- Database/schema'),
('      ''ENVIRONMENT_BASED'',    -- Policy type'),
('      ''ENV_COLUMN'',           -- Filter column'),
('      NULL,                    -- Custom expression (for CUSTOM type)'),
('      ''Filter by environment''-- Description'),
('  );'),
(''),
('  -- Policy types:'),
('    ENVIRONMENT_BASED - Filter by user environment access (SRF_* roles)'),
('    ROLE_BASED        - Filter by role membership'),
('    ATTRIBUTE_BASED   - Filter by user attributes'),
('    CUSTOM            - Custom predicate expression'),
(''),
('  -- Apply to table'),
('  CALL RBAC_APPLY_ROW_ACCESS_POLICY('),
('      ''ADMIN'', ''GOVERNANCE'', ''ENV_FILTER'','),
('      ''MY_DB'', ''MY_SCHEMA'', ''MY_TABLE'', ''ENV_COLUMN'''),
('  );'),
(''),
('MASKING POLICIES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create standard masking policies'),
('  CALL RBAC_SETUP_STANDARD_MASKING_POLICIES(''ADMIN'', ''GOVERNANCE'');'),
(''),
('  -- Creates: MASK_EMAIL, MASK_PHONE, MASK_SSN, MASK_CREDIT_CARD,'),
('  --          MASK_STRING_FULL, MASK_NAME_PARTIAL, MASK_DATE_YEAR,'),
('  --          MASK_NUMBER_ZERO, MASK_ID_HASH'),
(''),
('  -- Create custom masking policy'),
('  CALL RBAC_CREATE_MASKING_POLICY('),
('      ''MASK_CUSTOM'',         -- Policy name'),
('      ''ADMIN'', ''GOVERNANCE'',-- Database/schema'),
('      ''VARCHAR'',             -- Data type'),
('      ''PARTIAL_MASK'',        -- Masking type'),
('      ARRAY_CONSTRUCT(''SRS_SYSTEM_ADMIN''), -- Unmasked roles'),
('      1,                      -- Show first N chars'),
('      4,                      -- Show last N chars'),
('      NULL,                   -- Custom expression'),
('      ''Custom partial mask'' -- Description'),
('  );'),
(''),
('  -- Masking types:'),
('    FULL_MASK, PARTIAL_MASK, EMAIL_MASK, PHONE_MASK, SSN_MASK,'),
('    CREDIT_CARD_MASK, NULL_MASK, HASH_MASK, DATE_MASK, CUSTOM'),
(''),
('DATA CLASSIFICATION'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Auto-classify table based on column name patterns'),
('  CALL RBAC_AUTO_CLASSIFY_TABLE(''MY_DB'', ''MY_SCHEMA'', ''MY_TABLE'');'),
(''),
('  -- Manually classify a column'),
('  CALL RBAC_CLASSIFY_COLUMN('),
('      ''MY_DB'', ''MY_SCHEMA'', ''MY_TABLE'', ''SSN_COL'','),
('      ''PII'',        -- Classification tag'),
('      ''CRITICAL'',   -- Sensitivity level'),
('      ''SSN'',        -- Data type category'),
('      TRUE,          -- Requires masking'),
('      FALSE          -- Requires RLS'),
('  );'),
(''),
('GOVERNANCE TAGS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create standard governance tags'),
('  CALL RBAC_SETUP_STANDARD_GOVERNANCE_TAGS(''ADMIN'', ''GOVERNANCE'');'),
(''),
('  -- Creates: DATA_CLASSIFICATION, PII, PHI, PCI, DATA_TYPE,'),
('  --          RETENTION_PERIOD, DATA_OWNER, MASKING_REQUIRED'),
(''),
('  -- Apply tag to object'),
('  CALL RBAC_APPLY_TAG('),
('      ''ADMIN'', ''GOVERNANCE'', ''PII'', ''YES'','),
('      ''COLUMN'',                                    -- Target type'),
('      ''MY_DB'', ''MY_SCHEMA'', ''MY_TABLE'', ''EMAIL'' -- Target'),
('  );'),
(''),
('BULK OPERATIONS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Apply masking to all classified sensitive columns'),
('  CALL RBAC_APPLY_MASKING_TO_CLASSIFIED('),
('      ''ADMIN'', ''GOVERNANCE'',  -- Policy location'),
('      NULL, NULL,               -- Target database/schema (NULL = all)'),
('      TRUE                      -- Dry run (FALSE to execute)'),
('  );'),
(''),
('MONITORING'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Unified governance dashboard'),
('  CALL RBAC_GOVERNANCE_MONITORING_DASHBOARD();'),
(''),
('  -- Individual dashboards'),
('  CALL RBAC_POLICY_COVERAGE_DASHBOARD(NULL);'),
('  CALL RBAC_CLASSIFICATION_STATUS_DASHBOARD();'),
('  CALL RBAC_GOVERNANCE_COMPLIANCE_SCORECARD();'),
('  CALL RBAC_SENSITIVE_DATA_MAP(NULL);'),
('  CALL RBAC_SCAN_UNPROTECTED_DATA(NULL, NULL);'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- BACKUP
    -- =========================================================================
    WHEN 'BACKUP' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     BACKUP MANAGEMENT                                        ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('OVERVIEW'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  The Backup module provides point-in-time backup capabilities using'),
('  Snowflake''s zero-copy cloning technology:'),
('    • Instant backup creation (no data movement)'),
('    • Storage-efficient (only changed data consumes space)'),
('    • Granular recovery (database, schema, or table level)'),
('    • Scheduled backups with retention policies'),
(''),
('SCHEMA LOCATION: ADMIN.BACKUP'),
(''),
('BACKUP OPERATIONS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create a backup'),
('  CALL RBAC_CREATE_BACKUP('),
('      ''MY_DATABASE'',   -- Source database'),
('      ''MY_SCHEMA'',     -- Source schema (NULL = full database)'),
('      NULL,             -- Source table (NULL = full schema)'),
('      ''ADHOC'',         -- Tag: ADHOC, DAILY, WEEKLY, MONTHLY, YEARLY'),
('      NULL,             -- Target database (NULL = auto-generate)'),
('      NULL,             -- Time travel point (NULL = current)'),
('      30,               -- Retention days'),
('      NULL,             -- Policy ID (for scheduled backups)'),
('      ''Manual backup before release''  -- Description'),
('  );'),
(''),
('  -- Quick backup (simplified)'),
('  CALL RBAC_QUICK_BACKUP(''MY_DATABASE'', ''MY_SCHEMA'', NULL);'),
(''),
('BACKUP POLICIES'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create a backup policy'),
('  CALL RBAC_CREATE_BACKUP_POLICY('),
('      ''DAILY_HR_BACKUP'',  -- Policy name'),
('      ''HR_PRD'',           -- Source database'),
('      ''EMPLOYEES'',        -- Source schema (NULL = full database)'),
('      NULL,                -- Source table (NULL = full schema)'),
('      ''DAILY'',            -- Frequency: HOURLY, DAILY, WEEKLY, MONTHLY, YEARLY'),
('      30,                  -- Retention days'),
('      NULL,                -- Target database'),
('      TRUE                 -- Is active'),
('  );'),
(''),
('  -- Setup automated schedule'),
('  CALL RBAC_SETUP_BACKUP_SCHEDULE(''DAILY_HR_BACKUP'', ''ADMIN_WH'');'),
(''),
('  -- Pause/resume schedule'),
('  CALL RBAC_TOGGLE_BACKUP_SCHEDULE(''DAILY_HR_BACKUP'', ''PAUSE'');'),
('  CALL RBAC_TOGGLE_BACKUP_SCHEDULE(''DAILY_HR_BACKUP'', ''RESUME'');'),
(''),
('RESTORE OPERATIONS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Restore from backup (CLONE, SWAP, or OVERWRITE)'),
('  CALL RBAC_RESTORE_FROM_BACKUP('),
('      ''<backup_id>'',    -- From RBAC_LIST_BACKUPS'),
('      ''CLONE'',          -- Method: CLONE, SWAP, OVERWRITE'),
('      NULL,              -- Target name (NULL = auto-generate)'),
('      ''Restore reason'' -- Reason for audit'),
('  );'),
(''),
('  -- Restore using Time Travel'),
('  CALL RBAC_RESTORE_TIME_TRAVEL('),
('      ''MY_DATABASE'', ''MY_SCHEMA'', ''MY_TABLE'','),
('      ''2024-01-15 10:30:00''::TIMESTAMP_NTZ,'),
('      NULL'),
('  );'),
(''),
('RETENTION & CLEANUP'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- List all backups'),
('  CALL RBAC_LIST_BACKUPS(NULL, NULL, NULL, ''ACTIVE'');'),
(''),
('  -- Delete specific backup'),
('  CALL RBAC_DELETE_BACKUP(''<backup_id>'', ''Reason'');'),
(''),
('  -- Cleanup expired backups'),
('  CALL RBAC_CLEANUP_EXPIRED_BACKUPS(TRUE);  -- Dry run'),
('  CALL RBAC_CLEANUP_EXPIRED_BACKUPS(FALSE); -- Execute'),
(''),
('  -- Setup automatic retention cleanup'),
('  CALL RBAC_SETUP_RETENTION_CLEANUP(''ADMIN_WH'', ''DAILY'');'),
(''),
('MONITORING'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Unified backup monitoring dashboard'),
('  CALL RBAC_BACKUP_MONITORING_DASHBOARD();'),
(''),
('  -- Individual dashboards'),
('  CALL RBAC_BACKUP_STATUS_DASHBOARD();'),
('  CALL RBAC_BACKUP_STORAGE_DASHBOARD();'),
('  CALL RBAC_BACKUP_COMPLIANCE_REPORT();'),
('  CALL RBAC_BACKUP_HEALTH_CHECK();'),
('  CALL RBAC_TIME_TRAVEL_COVERAGE_DASHBOARD(NULL);'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- HADR
    -- =========================================================================
    WHEN 'HADR' THEN
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     HIGH AVAILABILITY / DISASTER RECOVERY                    ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('OVERVIEW'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  The HA/DR module provides business continuity capabilities:'),
('    • Cross-region database replication'),
('    • Cross-account replication for DR'),
('    • Planned and unplanned failover'),
('    • DR testing and validation'),
('    • RTO/RPO monitoring'),
(''),
('SCHEMA LOCATION: ADMIN.HADR'),
(''),
('REPLICATION SETUP'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Create a replication group'),
('  CALL RBAC_CREATE_REPLICATION_GROUP('),
('      ''DR_GROUP_1'',           -- Group name'),
('      ''CROSS_ACCOUNT'',        -- Type: CROSS_REGION, CROSS_ACCOUNT'),
('      ''ACCOUNT_123'',          -- Target account'),
('      ''AWS_US_EAST_1'',        -- Target region'),
('      ARRAY_CONSTRUCT(''DB1'', ''DB2''),  -- Databases to replicate'),
('      60,                      -- RPO target (minutes)'),
('      240,                     -- RTO target (minutes)'),
('      ''USING CRON 0 * * * * UTC''  -- Schedule'),
('  );'),
(''),
('  -- Simple database replication'),
('  CALL RBAC_SETUP_DATABASE_REPLICATION('),
('      ''MY_DATABASE'','),
('      ''TARGET_ACCOUNT'','),
('      ''10 MINUTE'''),
('  );'),
(''),
('  -- Manual refresh'),
('  CALL RBAC_REFRESH_REPLICATION(''DR_GROUP_1'');'),
(''),
('FAILOVER OPERATIONS'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Planned failover (zero data loss)'),
('  CALL RBAC_INITIATE_FAILOVER('),
('      ''DR_GROUP_1'','),
('      ''PLANNED'','),
('      ''Scheduled maintenance'','),
('      TRUE  -- Confirm (required)'),
('  );'),
(''),
('  -- Unplanned/emergency failover'),
('  CALL RBAC_INITIATE_FAILOVER('),
('      ''DR_GROUP_1'','),
('      ''UNPLANNED'','),
('      ''Primary region outage'','),
('      TRUE  -- Confirm (required)'),
('  );'),
(''),
('  -- Failback to original primary'),
('  CALL RBAC_INITIATE_FAILBACK(''DR_GROUP_1'', TRUE);'),
(''),
('DR TESTING'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Schedule a DR test'),
('  CALL RBAC_SCHEDULE_DR_TEST('),
('      ''Q1_DR_TEST'',            -- Test name'),
('      ''DR_GROUP_1'',            -- Group to test'),
('      ''CONNECTIVITY'',          -- Type: CONNECTIVITY, FAILOVER_SIMULATION,'),
('                                --       FULL_FAILOVER, DATA_VALIDATION'),
('      NULL                      -- Scheduled time (NULL = now)'),
('  );'),
(''),
('  -- Execute a scheduled test'),
('  CALL RBAC_EXECUTE_DR_TEST(''<test_id>'');'),
(''),
('  -- List DR tests'),
('  CALL RBAC_LIST_DR_TESTS(NULL);'),
(''),
('STATUS & MONITORING'),
('─────────────────────────────────────────────────────────────────────────────────'),
(''),
('  -- Unified HA/DR monitoring dashboard'),
('  CALL RBAC_HADR_MONITORING_DASHBOARD();'),
(''),
('  -- Check replication status'),
('  CALL RBAC_CHECK_REPLICATION_STATUS(NULL);'),
(''),
('  -- Individual dashboards'),
('  CALL RBAC_REPLICATION_HEALTH_DASHBOARD();'),
('  CALL RBAC_FAILOVER_READINESS_DASHBOARD();'),
('  CALL RBAC_RTORPO_COMPLIANCE_DASHBOARD();'),
('  CALL RBAC_DR_TEST_RESULTS_DASHBOARD();'),
(''),
('  -- Generate DR runbook'),
('  CALL RBAC_GENERATE_DR_RUNBOOK(''DR_GROUP_1'');'),
(''),
('  -- List failover groups'),
('  CALL RBAC_LIST_FAILOVER_GROUPS();'),
(''),
('─────────────────────────────────────────────────────────────────────────────────')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    -- =========================================================================
    -- DEFAULT - Unknown topic
    -- =========================================================================
    ELSE
        res := (SELECT * FROM VALUES
('╔══════════════════════════════════════════════════════════════════════════════╗'),
('║                     TOPIC NOT FOUND                                          ║'),
('╚══════════════════════════════════════════════════════════════════════════════╝'),
(''),
('Unknown topic: ' || v_topic),
(''),
('Run CALL RBAC_HELP(); to see all available topics.'),
(''),
('AVAILABLE TOPICS:'),
('  OVERVIEW, SETUP, QUICKSTART, ROLES, SRS, SRF, SRA, SRW, SRD,'),
('  PROCEDURES, SSO, SCIM_MODELS, MULTI_ACCOUNT, EXTERNAL,'),
('  EXTENSIBILITY, NATIVE_APP, DEVOPS, DEVOPS_SETUP, DEVOPS_GIT,'),
('  DEVOPS_DEPLOY, DEVOPS_PROMOTE, DEVOPS_ROLLBACK, CLONES,'),
('  CLONE_CREATE, CLONE_MANAGE, CLONE_AUDIT, CLONE_POLICIES,'),
('  MONITORING, MON_SECURITY, MON_CLONES, MON_DEVOPS, GOVERNANCE,'),
('  BACKUP, HADR,'),
('  EXAMPLE_SETUP, EXAMPLE_USER, EXAMPLE_SERVICE, EXAMPLE_DEVOPS, EXAMPLE_CLONE')
        AS t(DOCUMENTATION));
        RETURN TABLE(res);

    END CASE;

EXCEPTION
    WHEN OTHER THEN
        res := (SELECT * FROM VALUES
            ('ERROR: ' || SQLERRM)
        AS t(DOCUMENTATION));
        RETURN TABLE(res);
END;
$$;

-- =============================================================================
-- CONVENIENCE ALIASES
-- =============================================================================

CREATE OR REPLACE SECURE PROCEDURE RBAC_HELP_SETUP()
RETURNS TABLE (DOCUMENTATION VARCHAR)
LANGUAGE SQL
AS $$ BEGIN RETURN TABLE(SELECT * FROM TABLE(RBAC_HELP('SETUP'))); END; $$;

CREATE OR REPLACE SECURE PROCEDURE RBAC_HELP_ROLES()
RETURNS TABLE (DOCUMENTATION VARCHAR)
LANGUAGE SQL
AS $$ BEGIN RETURN TABLE(SELECT * FROM TABLE(RBAC_HELP('ROLES'))); END; $$;

CREATE OR REPLACE SECURE PROCEDURE RBAC_HELP_PROCEDURES()
RETURNS TABLE (DOCUMENTATION VARCHAR)
LANGUAGE SQL
AS $$ BEGIN RETURN TABLE(SELECT * FROM TABLE(RBAC_HELP('PROCEDURES'))); END; $$;

CREATE OR REPLACE SECURE PROCEDURE RBAC_HELP_QUICKSTART()
RETURNS TABLE (DOCUMENTATION VARCHAR)
LANGUAGE SQL
AS $$ BEGIN RETURN TABLE(SELECT * FROM TABLE(RBAC_HELP('QUICKSTART'))); END; $$;

CREATE OR REPLACE SECURE PROCEDURE RBAC_HELP_DEVOPS()
RETURNS TABLE (DOCUMENTATION VARCHAR)
LANGUAGE SQL
AS $$ BEGIN RETURN TABLE(SELECT * FROM TABLE(RBAC_HELP('DEVOPS'))); END; $$;

CREATE OR REPLACE SECURE PROCEDURE RBAC_HELP_CLONES()
RETURNS TABLE (DOCUMENTATION VARCHAR)
LANGUAGE SQL
AS $$ BEGIN RETURN TABLE(SELECT * FROM TABLE(RBAC_HELP('CLONES'))); END; $$;

CREATE OR REPLACE SECURE PROCEDURE RBAC_HELP_GOVERNANCE()
RETURNS TABLE (DOCUMENTATION VARCHAR)
LANGUAGE SQL
AS $$ BEGIN RETURN TABLE(SELECT * FROM TABLE(RBAC_HELP('GOVERNANCE'))); END; $$;

CREATE OR REPLACE SECURE PROCEDURE RBAC_HELP_BACKUP()
RETURNS TABLE (DOCUMENTATION VARCHAR)
LANGUAGE SQL
AS $$ BEGIN RETURN TABLE(SELECT * FROM TABLE(RBAC_HELP('BACKUP'))); END; $$;

CREATE OR REPLACE SECURE PROCEDURE RBAC_HELP_HADR()
RETURNS TABLE (DOCUMENTATION VARCHAR)
LANGUAGE SQL
AS $$ BEGIN RETURN TABLE(SELECT * FROM TABLE(RBAC_HELP('HADR'))); END; $$;

-- =============================================================================
-- GRANT EXECUTE
-- =============================================================================

-- Main help procedure - grant to PUBLIC so everyone can access documentation
GRANT USAGE ON PROCEDURE RBAC_HELP(VARCHAR) TO ROLE PUBLIC;
GRANT USAGE ON PROCEDURE RBAC_HELP_SETUP() TO ROLE PUBLIC;
GRANT USAGE ON PROCEDURE RBAC_HELP_ROLES() TO ROLE PUBLIC;
GRANT USAGE ON PROCEDURE RBAC_HELP_PROCEDURES() TO ROLE PUBLIC;
GRANT USAGE ON PROCEDURE RBAC_HELP_QUICKSTART() TO ROLE PUBLIC;
GRANT USAGE ON PROCEDURE RBAC_HELP_DEVOPS() TO ROLE PUBLIC;
GRANT USAGE ON PROCEDURE RBAC_HELP_CLONES() TO ROLE PUBLIC;
GRANT USAGE ON PROCEDURE RBAC_HELP_GOVERNANCE() TO ROLE PUBLIC;
GRANT USAGE ON PROCEDURE RBAC_HELP_BACKUP() TO ROLE PUBLIC;
GRANT USAGE ON PROCEDURE RBAC_HELP_HADR() TO ROLE PUBLIC;
